<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Refcard SQL</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Fabrice Niessen" />
<meta name="keywords" content="sql, emacs, yasnippet, snippets, code templates" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">Refcard SQL</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8ca618b">Sqsh</a></li>
<li><a href="#org8d932b6">Mssql-cli</a>
<ul>
<li><a href="#orgb0078b9">Features</a></li>
<li><a href="#orgdcf4f36">Setup</a></li>
</ul>
</li>
<li><a href="#org4ef9a21">Emacs YASnippets</a>
<ul>
<li><a href="#org53e4494">Insert Snippet&#x2026;</a>
<ul>
<li><a href="#org36ff2f9">Cursor</a></li>
<li><a href="#orgfc64e23">Database</a></li>
<li><a href="#org15bdfee">Fragment</a></li>
<li><a href="#orgfed6c28">Function</a></li>
<li><a href="#orgff1261d">Help</a></li>
<li><a href="#org342a361">Index</a></li>
<li><a href="#orgc41cbdf">Join fragment</a></li>
<li><a href="#org7efe560">Login</a></li>
<li><a href="#org3532144">Role</a></li>
<li><a href="#org7012188">Schema</a></li>
<li><a href="#orgf0ddabb">Set options</a></li>
<li><a href="#org90686b0">Stored Procedure</a></li>
<li><a href="#org8074d91">Synonym</a></li>
<li><a href="#org5b0138f">Table</a></li>
<li><a href="#org95e2684">Transaction</a></li>
<li><a href="#org2ceacc0">Trigger</a></li>
<li><a href="#org0eab835">User</a></li>
<li><a href="#orge295673">User Defined Data Type</a></li>
<li><a href="#org67e7e55">User Defined Table Type</a></li>
<li><a href="#org72cd046">User Defined Type</a></li>
<li><a href="#org9e08884">View</a></li>
<li><a href="#orgad9314d">&#x2014; Miscellaneous ---</a></li>
</ul>
</li>
<li><a href="#orgb5fafeb">Surround With&#x2026;</a>
<ul>
<li><a href="#org29135fd">[begin] Code Snippet for BEGIN&#x2026;END block</a></li>
<li><a href="#org06728df">[if] Code Snippet for IF construct</a></li>
<li><a href="#org0e8fa20">[while] Code Snippet for WHILE loop</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5d078e8">General SQL</a>
<ul>
<li><a href="#org6718213"><span class="todo TODO">TODO</span> Tips and Tricks to Make SQL Server Management Studio Awesome</a></li>
<li><a href="#orgf1c1658">SQL Server - Trace SQL</a></li>
<li><a href="#org1b5e4eb">SQL Dates</a></li>
<li><a href="#org60d2091">Code formatting</a></li>
<li><a href="#org729d64d">Table name as variable</a></li>
<li><a href="#orgb7e32e5">SQL Loop</a>
<ul>
<li><a href="#org079a3d8">While loop with temporary table</a></li>
<li><a href="#orgbdf2ad9">Cursor-like FETCH-NEXT logic</a></li>
<li><a href="#orgdcc641f">Cursor</a></li>
</ul>
</li>
<li><a href="#org637a0ba">SQL error on update: The UPDATE statement conflicted with the FOREIGN KEY constraint</a></li>
<li><a href="#orgdea4c17">Debugging triggers</a></li>
<li><a href="#orgcd1ab7b">Conversion failed when converting date and/or time from character string while inserting datetime</a></li>
<li><a href="#orgac27f08">Retrieve DB version information</a>
<ul>
<li><a href="#org4634f1a">SQL Server</a></li>
<li><a href="#org32e1010">Oracle</a></li>
</ul>
</li>
<li><a href="#org1567d6b">List all columns (sfss, afm-fields, for all the fields in the SQL Database Schema)</a></li>
<li><a href="#org986dce0">6 Useful SQL Server Data Dictionary Queries Every DBA Should Have</a></li>
<li><a href="#orgc175011">Over 40 queries to find SQL Server tables with or without a certain property</a></li>
<li><a href="#org8473be2">List all constraints</a></li>
<li><a href="#orgf8a9065">List all PRIMARY KEY constraints</a></li>
<li><a href="#orga725a1d">List all FOREIGN KEY constraints</a>
<ul>
<li><a href="#orged09570">The DELETE statement conflicted with the REFERENCE constraint</a></li>
</ul>
</li>
<li><a href="#org9b0ff7c">Disable/enable all constraints in the database</a></li>
<li><a href="#org59cf545">Disable/enable all constraints on a table</a></li>
<li><a href="#orgf93fdc0">List all non-NULLABLE columns</a></li>
<li><a href="#org4cecb19">List all DEFAULT constraints (with default value)</a></li>
<li><a href="#orgb67a88c">List all IDENTITY columns</a>
<ul>
<li><a href="#org3a0ec10">How to remove Identity from a column in a table?</a></li>
</ul>
</li>
<li><a href="#org6822a4f">List triggers</a>
<ul>
<li><a href="#org5bdc7c5">Nested triggers (server option)</a></li>
<li><a href="#org7345c89">Recursive triggers (database option)</a></li>
<li><a href="#org5744fc0">For EPO cascading_update/delete triggers</a></li>
</ul>
</li>
<li><a href="#org66d8b41">Using a DML trigger with a reminder e-mail message</a></li>
<li><a href="#orga8bb223">List all stored procedures and functions</a></li>
<li><a href="#org11579d0">List all views, stored procedures, functions and triggers REFERENCING a particular table</a></li>
<li><a href="#org1d42dc0">List all indexes and index columns</a></li>
<li><a href="#orgf9fccbc">SQL Collation</a></li>
<li><a href="#org39b79d1">Finding and Eliminating Duplicate or Overlapping Indexes</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8ca618b" class="outline-2">
<h2 id="org8ca618b">Sqsh</h2>
<div class="outline-text-2" id="text-org8ca618b">
<div class="org-src-container">
<pre class="src src-conf"><span class="org-comment-delimiter"># </span><span class="org-comment">Hey Emacs, this is a -*- conf -*- file</span>
<span class="org-comment-delimiter">## </span><span class="org-comment">.sqshrc - My sqsh initialization file</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Copyright (C) 2010-&lt;&lt;current-year()&gt;&gt; Fabrice Niessen</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Author: Fabrice Niessen &lt;(concat "fni" at-symbol "pirilampo.org")&gt;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Keywords: sqsh, dotfile, config</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">* Connections</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Setting your password within your `.sqshrc' is probably the most secure method</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">of using sqsh.  However, make sure that you `chmod go-rwx ~/.sqshrc',</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">otherwise you leave yourself wide open to attacks.</span>

<span class="org-variable-name">\set username</span>=<span class="org-string">"sa"</span>
<span class="org-variable-name">\set password</span>=<span class="org-string">"mysecret"</span>
<span class="org-variable-name">\set hostname</span>=<span class="org-string">"localhost"</span>
<span class="org-variable-name">\set database</span>=[ARCHIBUS_23_2_HQ]

<span class="org-comment-delimiter">#</span><span class="org-comment">* Aliasing</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">** Display styles</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">\set colsep='| '</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Currently supported styles are:</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- horiz (or hor or horizontal) (*) = default</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- vert (or vertical) (*),</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- bcp,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- csv,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- html,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- meta,</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- pretty (*), and</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">- none.</span>

<span class="org-variable-name">\alias goh</span>=<span class="org-string">'\go -m horiz | ${PAGER}'</span>

<span class="org-variable-name">\alias gov</span>=<span class="org-string">'\go -m vert | ${PAGER}'</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">*Very* useful for doing quick bcp commands from command line, and using</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">re-direction directly to a file!</span>
<span class="org-variable-name">\alias gob</span>=<span class="org-string">'\go -m bcp | ${PAGER}'</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Firefox.</span>
<span class="org-variable-name">\alias gof</span>=<span class="org-string">'\go -m html | (cat &gt; /tmp/sqsh-output.html; /mnt/c/Windows/explorer.exe file:///tmp/sqsh-output.html)'</span>

<span class="org-variable-name">\alias gom</span>=<span class="org-string">'\go -m meta | ${PAGER}'</span>

<span class="org-variable-name">\alias gop</span>=<span class="org-string">'\go -m pretty -w80 | ${PAGER}'</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">** Aliases for T-SQL commands</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-conf"><span class="org-variable-name">\alias statson</span>=<span class="org-string">'\loop -e "SET STATISTICS IO ON; SET STATISTICS TIME ON;"'</span>
<span class="org-variable-name">\alias statsoff</span>=<span class="org-string">'\loop -e "SET STATISTICS IO OFF; SET STATISTICS TIME OFF;"'</span>
</pre>
</div>

<p>
SQL Server Execution Time: This refers to the time taken by SQL server to
complete the execution of the compiled plan.
</p>

<p>
<b>CPU time</b> refers to the actual time spent on CPU.
</p>

<p>
The <b>elapsed time</b> is the total time to complete the execution which includes
</p>
<ul class="org-ul">
<li>signal wait time,</li>
<li>wait time to complete the IO operation and</li>
<li>time taken to transfer the output to the client.</li>
</ul>

<p>
<b>CPU time</b> is really where you want to pay attention for <b>performance tuning</b>, as it
can be
</p>
<ul class="org-ul">
<li>higher than the <b>elapsed time</b> if the query goes parallel, or</li>
<li>lower if the procedure spends time sleeping on wait signals and I/O
operations.</li>
</ul>

<p>
The <b>CPU time</b> can be used to baseline the performance tuning. This value will not
vary much from execution to execution unless you modify the query or data. The
load on the server will not impact much on this value.
</p>

<p>
The <b>elapsed time</b> will depend on many factors, like load on the server, IO load,
network bandwidth between server and client.
</p>

<p>
So always use the CPU time as baseline while doing the performance tuning.
</p>

<p>
Want to <b>format your output</b> online in a web browser?  The <a href="http://statisticsparser.com/index.html">Statistics Parser</a> will
help with that. Just paste in the output of Statistics IO and/or Statistics Time
and press Parse. Your output will be formatted and totaled. Enjoy.
</p>

<div class="org-src-container">
<pre class="src src-conf"><span class="org-variable-name">\alias planon</span>=<span class="org-string">'\loop -e "SET SHOWPLAN ON"'</span>
<span class="org-variable-name">\alias planoff</span>=<span class="org-string">'\loop -e "SET SHOWPLAN OFF"'</span>

<span class="org-variable-name">\alias ton</span>=<span class="org-string">'\loop -e "DBCC TRACEON(3604)"'</span>
<span class="org-variable-name">\alias toff</span>=<span class="org-string">'\loop -e "DBCC TRACEOFF(3604)"'</span>

<span class="org-variable-name">\alias tempdb</span>=<span class="org-string">'\loop -e "USE tempdb"'</span>
<span class="org-variable-name">\alias master</span>=<span class="org-string">'\loop -e "USE master"'</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">** Aliases for sqsh commands</span>

<span class="org-variable-name">\alias DEV</span>=<span class="org-string">'\reconnect -SDEV -Usa -Pmysecret'</span>
<span class="org-variable-name">\alias STG</span>=<span class="org-string">'\reconnect -SSTG -Usa -Pmysecret'</span>
<span class="org-variable-name">\alias PRD</span>=<span class="org-string">'\reconnect -c -SPRD -Usa -Pmysecret'</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Clear screen within sqsh session.</span>
<span class="org-variable-name">\alias clear</span>=<span class="org-string">"\shell clear"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Read a file into sqsh session.</span>
<span class="org-variable-name">\alias :r</span>=<span class="org-string">'\buf-load -a !*'</span>
<span class="org-variable-name">\alias r</span>=<span class="org-string">"\buf-load "</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Drop you into a shell out of sqsh.</span>
<span class="org-variable-name">\alias sh</span>=<span class="org-string">"\shell "</span>

<span class="org-variable-name">\alias h</span>=<span class="org-string">"\history"</span>

<span class="org-variable-name">\alias xx</span>=<span class="org-string">'\reset'</span>

<span class="org-variable-name">\alias q</span>=<span class="org-string">"\exit"</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">* Miscellaneous</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Turn off the sqsh banner; cosmetic only</span>
<span class="org-variable-name">\set banner</span>=no

<span class="org-variable-name">\set width</span>=65535

<span class="org-comment-delimiter"># </span><span class="org-comment">Have semicolons executing commands (sort of inline "go")...</span>
<span class="org-variable-name">\set semicolon_hack</span>=on

<span class="org-comment-delimiter"># </span><span class="org-comment">Turn on ability to have !-recall commands.</span>
<span class="org-variable-name">\set history_shorthand</span>=on

<span class="org-comment-delimiter"># </span><span class="org-comment">This variable causes sqsh to exit with an exit status of the total number of</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">batches that failed during the current session.  This is useful for use within</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">shell scripts and the such.</span>
<span class="org-variable-name">\set exit_failcount</span>=on

<span class="org-variable-name">\set prompt_color</span>=<span class="org-string">'{0;34;47}'</span>
<span class="org-variable-name">\set text_color</span>=<span class="org-string">'{0;33}'</span>
<span class="org-variable-name">\set prompt</span>=<span class="org-string">'$prompt_color{{$username@$DSQUERY:$database}}&gt;$text_color '</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">This is for the sake of Emacs.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Local Variables&#58;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">mode: outline-minor</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">End:</span>

<span class="org-comment-delimiter">## </span><span class="org-comment">.sqshrc ends here</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d932b6" class="outline-2">
<h2 id="org8d932b6">Mssql-cli</h2>
<div class="outline-text-2" id="text-org8d932b6">
</div>
<div id="outline-container-orgb0078b9" class="outline-3">
<h3 id="orgb0078b9">Features</h3>
<div class="outline-text-3" id="text-orgb0078b9">
<p>
New and interactive command line query tool for SQL Server. This open source
tool works cross-platform and is a proud member of the dbcli community.
</p>

<p>
Features
</p>
<ul class="org-ul">
<li>Mssql-cli auto-completion that is context aware</li>
<li>T-SQL IntelliSense</li>
<li>Syntax highlighting</li>
<li>Pretty formatting for query results, including Vertical Format</li>
<li>Multi-line edit mode</li>
<li>Configuration file support</li>
</ul>

<p>
<a href="https://cloudblogs.microsoft.com/sqlserver/2017/12/12/try-mssql-cli-a-new-interactive-command-line-tool-for-sql-server/">https://cloudblogs.microsoft.com/sqlserver/2017/12/12/try-mssql-cli-a-new-interactive-command-line-tool-for-sql-server/</a>
</p>
</div>
</div>

<div id="outline-container-orgdcf4f36" class="outline-3">
<h3 id="orgdcf4f36">Setup</h3>
<div class="outline-text-3" id="text-orgdcf4f36">
<div class="org-src-container">
<pre class="src src-shell">sudo apt install python-pip python-dev
sudo pip install --upgrade pip
sudo pip install mssql-cli
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">mssql-cli -E
kinit.exe user@domain.com
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4ef9a21" class="outline-2">
<h2 id="org4ef9a21">Emacs YASnippets</h2>
<div class="outline-text-2" id="text-org4ef9a21">
<p>
A <b>SQL &ldquo;snippet&rdquo;</b> (or <b>auto-replacement</b>) is a frequently used <b>code template</b> which
can be inserted into a code you are typing by pressing the TAB key.  It allows
you to write frequently used SQL commands more quickly.
</p>

<p>
Snippets are categorized into 2 types:
</p>

<ul class="org-ul">
<li><b>Insert Snippets (or Expansion Snippets)</b>: These are code templates for various
SQL commands you can quickly insert into your SQL code when creating tables,
stored procedures, triggers and so on.</li>

<li><b>Surround Snippets:</b> These are code templates that help you implement code
constructs such as <code>BEGIN...END</code>, <code>IF</code>, <code>WHILE</code> and so on.</li>
</ul>

<p>
See <a href="https://github.com/gvohra/sqlpromptsnippets">https://github.com/gvohra/sqlpromptsnippets</a> or sharing the best Red Gate SQL
Prompt snippets.
</p>

<p>
<a href="https://www.ssmsboost.com/">https://www.ssmsboost.com/</a>
</p>

<p>
<a href="https://www.ssmstoolspack.com/Download">https://www.ssmstoolspack.com/Download</a>
</p>
</div>

<div id="outline-container-org53e4494" class="outline-3">
<h3 id="org53e4494">Insert Snippet&#x2026;</h3>
<div class="outline-text-3" id="text-org53e4494">
</div>
<div id="outline-container-org36ff2f9" class="outline-4">
<h4 id="org36ff2f9">Cursor</h4>
<div class="outline-text-4" id="text-org36ff2f9">
</div>
<div id="outline-container-orgdb7d3ce" class="outline-5">
<h5 id="orgdb7d3ce">[curff] Cursor Fast-Forward</h5>
<div class="outline-text-5" id="text-orgdb7d3ce">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Fast-forward <span class="org-keyword">read</span>-<span class="org-keyword">on</span>...
# <span class="org-comment">--</span>
<span class="org-comment-delimiter">/* </span><span class="org-comment">declare variables */</span>
<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@variable</span> <span class="org-type">INT</span>

<span class="org-keyword">DECLARE</span> ${1:<span class="org-keyword">cursor_name</span>} <span class="org-type">CURSOR</span>
FAST_FORWARD READ_ONLY
<span class="org-keyword">FOR</span> ${2:select_statement}

<span class="org-keyword">OPEN</span> $1

<span class="org-keyword">FETCH</span> <span class="org-keyword">NEXT</span> <span class="org-keyword">FROM</span> $1
<span class="org-keyword">INTO</span> <span class="org-variable-name">@variable</span>

<span class="org-keyword">WHILE</span> <span class="org-builtin">@@FETCH_STATUS</span> = 0
<span class="org-keyword">BEGIN</span>
    $0

    <span class="org-keyword">FETCH</span> <span class="org-keyword">NEXT</span> <span class="org-keyword">FROM</span> $1
    <span class="org-keyword">INTO</span> <span class="org-variable-name">@variable</span>
<span class="org-keyword">END</span>

<span class="org-keyword">CLOSE</span> $1
<span class="org-keyword">DEALLOCATE</span> $1
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfc64e23" class="outline-4">
<h4 id="orgfc64e23">Database</h4>
<div class="outline-text-4" id="text-orgfc64e23">
</div>
<div id="outline-container-org4c25887" class="outline-5">
<h5 id="org4c25887">[cdb] Create DataBase</h5>
<div class="outline-text-5" id="text-org4c25887">
<p>
Create database.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">database</span>
# <span class="org-comment">--</span>
<span class="org-doc">USE master</span>
<span class="org-doc">go</span>

<span class="org-comment">-- Drop the database if it already exists.</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span>
        <span class="org-keyword">FROM</span> sys.databases
        <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'${1:database_name}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">DATABASE</span> $1
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">DATABASE</span> $1
<span class="org-keyword">ON</span>
<span class="org-keyword">PRIMARY</span> ( <span class="org-comment">-- or use FILEGROUP filegroup_name</span>
  <span class="org-keyword">NAME</span> = $1_data,
  FILENAME = <span class="org-string">'$1.mdf'</span>
) <span class="org-comment">--, and repeat as required</span>
<span class="org-builtin">LOG</span> <span class="org-keyword">ON</span>
(
  <span class="org-keyword">NAME</span> = $1_log,
  FILENAME = <span class="org-string">'$1.ldf'</span>
) <span class="org-comment">--, and repeat as required</span>
<span class="org-comment">--COLLATE collation_name</span>
<span class="org-comment">--WITH</span>
<span class="org-comment">--  DB_CHAINING ON/OFF</span>
<span class="org-comment">--  TRUSTWORTHY ON/OFF</span>
<span class="org-comment">--FOR LOAD</span>
<span class="org-comment">--FOR ATTACH</span>
<span class="org-comment">--WITH</span>
<span class="org-comment">--  ENABLE_BROKER</span>
<span class="org-comment">--  NEW_BROKER</span>
<span class="org-comment">--  ERROR_BROKER_CONVERSATIONS</span>
<span class="org-comment">--FOR ATTACH_REBUILD_LOG</span>
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d1b5c9" class="outline-5">
<h5 id="org6d1b5c9">[cdbsnap] Create DataBase Snapshot</h5>
<div class="outline-text-5" id="text-org6d1b5c9">
<p>
Create snapshot.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">database</span> sna...
# <span class="org-comment">--</span>
<span class="org-doc">USE master</span>
<span class="org-doc">go</span>

<span class="org-comment">-- Drop snapshot database if it already exists.</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span>
        <span class="org-keyword">FROM</span> sys.databases
        <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'${1:source_database}_${2:snapshot_id}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">DATABASE</span> $1_$2
<span class="org-doc">go</span>

<span class="org-comment">-- Create the snapshot database.</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">DATABASE</span> $1_$2 <span class="org-keyword">ON</span>
( <span class="org-keyword">NAME</span> = $1_$2_data,
  FILENAME = <span class="org-string">'$1_$2.ss'</span>)
<span class="org-keyword">AS</span> SNAPSHOT <span class="org-keyword">OF</span> $1;
<span class="org-doc">go$0</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9c61237" class="outline-5">
<h5 id="org9c61237">[dd] Drop Database</h5>
<div class="outline-text-5" id="text-org9c61237">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">database</span>
# <span class="org-comment">--</span>
<span class="org-doc">USE master</span>
<span class="org-doc">go</span>

<span class="org-comment">-- Drop the database if it already exists.</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span>
        <span class="org-keyword">FROM</span> sys.databases
        <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'${1:database_name}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">DATABASE</span> $1
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga67b187" class="outline-5">
<h5 id="orga67b187">Database Backup</h5>
<div class="outline-text-5" id="text-orga67b187">
<p>
Backup database.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Backup</span> <span class="org-keyword">database</span>
# <span class="org-comment">--</span>
<span class="org-keyword">BACKUP</span> <span class="org-keyword">DATABASE</span> ${1:database_name}
    <span class="org-keyword">TO</span> <span class="org-keyword">DISK</span> = N<span class="org-string">'Backup_Path/$1.bak'</span>
<span class="org-keyword">WITH</span>
    NOFORMAT,
    NOINIT,
    <span class="org-keyword">NAME</span> = N<span class="org-string">'$1-Full Database Backup'</span>,
    SKIP,
    STATS = 10;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2072638" class="outline-5">
<h5 id="org2072638">Database Restore</h5>
<div class="outline-text-5" id="text-org2072638">
<p>
Restore database.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Restore</span> <span class="org-keyword">database</span>
# <span class="org-comment">--</span>
<span class="org-doc">USE master</span>
<span class="org-doc">go</span>

<span class="org-keyword">RESTORE</span> <span class="org-keyword">DATABASE</span> ${1:database_name}
    <span class="org-keyword">FROM</span> <span class="org-keyword">DISK</span> = N<span class="org-string">'Backup_Path/$1.bak'</span>
<span class="org-keyword">WITH</span>
    <span class="org-keyword">FILE</span> = 1,
    NOUNLOAD,
    <span class="org-builtin">REPLACE</span>,
    STATS = 10
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org15bdfee" class="outline-4">
<h4 id="org15bdfee">Fragment</h4>
<div class="outline-text-4" id="text-org15bdfee">
</div>
<div id="outline-container-org5fc432b" class="outline-5">
<h5 id="org5fc432b">[cr] Create</h5>
<div class="outline-text-5" id="text-org5fc432b">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">CREATE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org64b7d3c" class="outline-5">
<h5 id="org64b7d3c">[i] Insert</h5>
<div class="outline-text-5" id="text-org64b7d3c">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">INSERT</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">INSERT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org693c0e5" class="outline-5">
<h5 id="org693c0e5">[ii] Insert Into</h5>
<div class="outline-text-5" id="text-org693c0e5">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> $0 ()
<span class="org-keyword">VALUES</span> ()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc07259a" class="outline-5">
<h5 id="orgc07259a">[s] Select</h5>
<div class="outline-text-5" id="text-orgc07259a">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">SELECT</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0284680" class="outline-5">
<h5 id="org0284680">[ssf] Select Star From</h5>
<div class="outline-text-5" id="text-org0284680">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> frag...
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> *
<span class="org-keyword">FROM</span> $0
<span class="org-keyword">WHERE</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc21da3" class="outline-5">
<h5 id="orgbc21da3">[sst] Select Top 10</h5>
<div class="outline-text-5" id="text-orgbc21da3">
<p>
Select top 10 rows.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">SELECT</span> <span class="org-keyword">top</span> 10 <span class="org-keyword">rows</span>
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 10 *
<span class="org-keyword">FROM</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org09eaada" class="outline-5">
<h5 id="org09eaada">[st100] Select Top 100</h5>
<div class="outline-text-5" id="text-org09eaada">
<p>
Select top 100 rows.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">SELECT</span> <span class="org-keyword">top</span> 100 <span class="org-keyword">rows</span>
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 100 *
<span class="org-keyword">FROM</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdee2ec9" class="outline-5">
<h5 id="orgdee2ec9">[scf] Select Count From</h5>
<div class="outline-text-5" id="text-orgdee2ec9">
<p>
Count number of records returned by query.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Count</span> <span class="org-keyword">number</span> <span class="org-keyword">of</span> rec...
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> FORMAT(<span class="org-keyword">COUNT</span>(*), <span class="org-string">'#,##0'</span>)
<span class="org-keyword">FROM</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org440f513" class="outline-5">
<h5 id="org440f513">[scgb] Select Count with Group By</h5>
<div class="outline-text-5" id="text-org440f513">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Count</span> <span class="org-keyword">with</span> <span class="org-keyword">group</span> <span class="org-keyword">by</span>
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> ${1:col}, <span class="org-keyword">COUNT</span>(*) <span class="org-keyword">FROM</span> $0 <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> $1
</pre>
</div>
</div>
</div>

<div id="outline-container-org8dd7c9e" class="outline-5">
<h5 id="org8dd7c9e">[num] Format Number</h5>
<div class="outline-text-5" id="text-org8dd7c9e">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Format <span class="org-keyword">number</span>
# <span class="org-comment">--</span>
FORMAT($0,<span class="org-string">'#,##0'</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2fea8b7" class="outline-5">
<h5 id="org2fea8b7">[smf] Select Sum From</h5>
<div class="outline-text-5" id="text-org2fea8b7">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">SELECT</span> <span class="org-keyword">SUM</span>(*) <span class="org-keyword">FROM</span>...
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">SUM</span>($0)
<span class="org-keyword">FROM</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f5410b" class="outline-5">
<h5 id="org3f5410b">[f] From</h5>
<div class="outline-text-5" id="text-org3f5410b">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">FROM</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">FROM</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga3c6a80" class="outline-5">
<h5 id="orga3c6a80">[is] INFORMATION_SCHEMA</h5>
<div class="outline-text-5" id="text-orga3c6a80">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: INFORMATION_SCH...
# <span class="org-comment">--</span>
INFORMATION_SCHEMA$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ab5138" class="outline-5">
<h5 id="org2ab5138">[w] Where</h5>
<div class="outline-text-5" id="text-org2ab5138">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">WHERE</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">WHERE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb75c43c" class="outline-5">
<h5 id="orgb75c43c">[lk] Like</h5>
<div class="outline-text-5" id="text-orgb75c43c">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">LIKE</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">LIKE</span> <span class="org-string">'%$0%'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8f97217" class="outline-5">
<h5 id="org8f97217">[today] Today</h5>
<div class="outline-text-5" id="text-org8f97217">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Today fragment
# <span class="org-comment">--</span>
<span class="org-builtin">CAST</span>(<span class="org-builtin">GETDATE</span>() <span class="org-keyword">AS</span> <span class="org-type">DATE</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org416d012" class="outline-5">
<h5 id="org416d012">[now] Now</h5>
<div class="outline-text-5" id="text-org416d012">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Now fragment
# <span class="org-comment">--</span>
`(format-<span class="org-type">time</span>-string "<span class="org-string">'%Y-%m-%d %H:%M:%S.%3N'</span>")`
</pre>
</div>
</div>
</div>

<div id="outline-container-orgec313cf" class="outline-5">
<h5 id="orgec313cf">[gb] Group By</h5>
<div class="outline-text-5" id="text-orgec313cf">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org548c5e3" class="outline-5">
<h5 id="org548c5e3">[ha] Having</h5>
<div class="outline-text-5" id="text-org548c5e3">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">HAVING</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">HAVING</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org61c88c7" class="outline-5">
<h5 id="org61c88c7">[ob] Order By</h5>
<div class="outline-text-5" id="text-org61c88c7">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org11c176f" class="outline-5">
<h5 id="org11c176f">[rwn] Row Number</h5>
<div class="outline-text-5" id="text-org11c176f">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: ROW_NUMBER fragment
# <span class="org-comment">--</span>
ROW_NUMBER() <span class="org-keyword">OVER</span>(PARTITION <span class="org-keyword">BY</span>  <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> )
</pre>
</div>
</div>
</div>

<div id="outline-container-org740ff9f" class="outline-5">
<h5 id="org740ff9f">[up] Update</h5>
<div class="outline-text-5" id="text-org740ff9f">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">UPDATE</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">UPDATE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org4aaeb27" class="outline-5">
<h5 id="org4aaeb27">[upd] Update</h5>
<div class="outline-text-5" id="text-org4aaeb27">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">UPDATE</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">UPDATE</span> $0
<span class="org-keyword">SET</span>
<span class="org-keyword">WHERE</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddd9054" class="outline-5">
<h5 id="orgddd9054">[d] Delete</h5>
<div class="outline-text-5" id="text-orgddd9054">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">DELETE</span> frag...
# <span class="org-comment">--</span>
<span class="org-keyword">DELETE</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ed4e72" class="outline-5">
<h5 id="org0ed4e72">[df] Delete From</h5>
<div class="outline-text-5" id="text-org0ed4e72">
<p>
Delete statement.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">DELETE</span> <span class="org-keyword">FROM</span> frag...
# <span class="org-comment">--</span>
<span class="org-keyword">DELETE</span> <span class="org-keyword">FROM</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
<span class="org-keyword">WHERE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org73ccb87" class="outline-5">
<h5 id="org73ccb87">[tt] Truncate Table</h5>
<div class="outline-text-5" id="text-org73ccb87">
<p>
Truncate statement.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">TRUNCATE</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">TRUNCATE</span> <span class="org-keyword">TABLE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orge3d1de1" class="outline-5">
<h5 id="orge3d1de1">[lin]</h5>
<div class="outline-text-5" id="text-orge3d1de1">
<p>
to split up code
</p>
</div>
</div>

<div id="outline-container-orgad78139" class="outline-5">
<h5 id="orgad78139">[linn]</h5>
<div class="outline-text-5" id="text-orgad78139">
<p>
as above, with space for commentary
</p>
</div>
</div>

<div id="outline-container-orgaae4b36" class="outline-5">
<h5 id="orgaae4b36">[header]</h5>
<div class="outline-text-5" id="text-orgaae4b36">
<p>
as above, with even  more space
</p>
</div>
</div>

<div id="outline-container-org4c340d8" class="outline-5">
<h5 id="org4c340d8">[deci] Declare Int</h5>
<div class="outline-text-5" id="text-org4c340d8">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">DECLARE</span> <span class="org-type">int</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@</span>$0 <span class="org-type">int</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge447a96" class="outline-5">
<h5 id="orge447a96">[decv] Declare Varchar</h5>
<div class="outline-text-5" id="text-orge447a96">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">DECLARE</span> <span class="org-type">varchar</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@</span>$0 <span class="org-type">varchar</span>(256)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7b9944b" class="outline-5">
<h5 id="org7b9944b">[be] Begin&#x2026;End</h5>
<div class="outline-text-5" id="text-org7b9944b">
<p>
Insert <code>BEGIN...END</code> block.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">BEGIN</span>...<span class="org-keyword">END</span> block
# <span class="org-comment">--</span>
<span class="org-keyword">BEGIN</span>
    $0
<span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd5b3fa8" class="outline-5">
<h5 id="orgd5b3fa8">[tc] Try &#x2026; Catch</h5>
<div class="outline-text-5" id="text-orgd5b3fa8">
<p>
Insert <code>TRY...CATCH</code> block.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: TRY ... CATCH fragm...
# <span class="org-comment">--</span>
<span class="org-keyword">BEGIN</span> TRY
    $0
<span class="org-keyword">END</span> TRY
<span class="org-keyword">BEGIN</span> CATCH
    <span class="org-comment-delimiter">/*</span>
<span class="org-comment">        SELECT</span>
<span class="org-comment">            ERROR_NUMBER() AS ErrorNumber,</span>
<span class="org-comment">            ERROR_SEVERITY() AS ErrorSeverity,</span>
<span class="org-comment">            ERROR_STATE() AS ErrorState,</span>
<span class="org-comment">            ERROR_PROCEDURE() AS ErrorProcedure,</span>
<span class="org-comment">            ERROR_LINE() AS ErrorLine,</span>
<span class="org-comment">            ERROR_MESSAGE() AS ErrorMessage</span>
<span class="org-comment">    */</span>
<span class="org-keyword">END</span> CATCH;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd7b98d" class="outline-5">
<h5 id="orgdd7b98d">[ifs] If</h5>
<div class="outline-text-5" id="text-orgdd7b98d">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">IF</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> 1 = 1
<span class="org-keyword">BEGIN</span>
    $0
<span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3108d4d" class="outline-5">
<h5 id="org3108d4d">[ex] Exists</h5>
<div class="outline-text-5" id="text-org3108d4d">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">EXISTS</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">EXISTS</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd5ef1f6" class="outline-5">
<h5 id="orgd5ef1f6">[nex] Not Exists</h5>
<div class="outline-text-5" id="text-orgd5ef1f6">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">NOT</span> <span class="org-keyword">EXISTS</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org97afdbe" class="outline-5">
<h5 id="org97afdbe">If Exists</h5>
<div class="outline-text-5" id="text-org97afdbe">
<p>
Perform an operation if a selected object exists.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: ...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span>(
 <span class="org-keyword">SELECT</span>
 <span class="org-keyword">FROM</span> ${1:<span class="org-type">object</span>})
 <span class="org-keyword">BEGIN</span>
    $0
 <span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1834e47" class="outline-5">
<h5 id="org1834e47">Case</h5>
<div class="outline-text-5" id="text-org1834e47">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CASE</span> <span class="org-comment-delimiter">/*</span><span class="org-comment">expression*/</span>
    <span class="org-keyword">WHEN</span> <span class="org-comment-delimiter">/*</span><span class="org-comment">expression*/</span> <span class="org-keyword">THEN</span> <span class="org-comment-delimiter">/*</span><span class="org-comment">result_expression*/</span>
    <span class="org-keyword">WHEN</span> <span class="org-comment-delimiter">/*</span><span class="org-comment">expression*/</span> <span class="org-keyword">THEN</span> <span class="org-comment-delimiter">/*</span><span class="org-comment">result_expression*/</span>
    <span class="org-keyword">ELSE</span> <span class="org-comment-delimiter">/*</span><span class="org-comment">result_expression*/</span>
<span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcb0c169" class="outline-5">
<h5 id="orgcb0c169">[cte] Common Table Expression</h5>
<div class="outline-text-5" id="text-orgcb0c169">
<p>
Temporary inline view.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">WITH</span> cte fragment
# <span class="org-comment">--</span>
;<span class="org-keyword">WITH</span> ${1:cte_name} <span class="org-keyword">AS</span>
(
    <span class="org-comment">-- SELECT</span>
    <span class="org-comment">-- FROM</span>
    <span class="org-comment">-- GROUP BY</span>
)
<span class="org-comment">-- Statement that executes the common table expression</span>
<span class="org-keyword">SELECT</span> $0
<span class="org-keyword">FROM</span> $1;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org46f2ef3" class="outline-5">
<h5 id="org46f2ef3">[wtf] What The Fuck</h5>
<div class="outline-text-5" id="text-org46f2ef3">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: WTF fragment
# <span class="org-comment">--</span>
WTF???!??!  AAAAAARRRRRRRRRRGGGGGGGGHHHHHHHHHHHHHHHHHHH!!!!!!!!!!!!!!!!!!
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfed6c28" class="outline-4">
<h4 id="orgfed6c28">Function</h4>
<div class="outline-text-4" id="text-orgfed6c28">
<p>
Naming convention: functions are prefixed with <code>ufn</code>.
</p>
</div>

<div id="outline-container-orgc005e20" class="outline-5">
<h5 id="orgc005e20">[ctif] Create Inline Table Function</h5>
<div class="outline-text-5" id="text-orgc005e20">
<p>
Creates an inline table function.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> inline <span class="org-keyword">table</span>-va...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (N<span class="org-string">'${1:[schema].[inline_function_name]}'</span>, N<span class="org-string">'IF'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">FUNCTION</span> $1;
<span class="org-doc">go</span>

<span class="org-comment">-- ================================================</span>
<span class="org-doc">SET ANSI_NULLS ON</span>
<span class="org-doc">go</span>
<span class="org-doc">SET QUOTED_IDENTIFIER ON</span>
<span class="org-doc">go</span>
<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Author:      /* Author */</span>
<span class="org-comment">-- Create date: /* Create Date */</span>
<span class="org-comment">-- Description: /* Description */</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">FUNCTION</span> $1 (<span class="org-variable-name">@</span>${2:<span class="org-keyword">parameter_name</span>} ${3:parameter_data_type})
<span class="org-keyword">RETURNS</span> <span class="org-keyword">TABLE</span>
<span class="org-comment">--WITH ENCRYPTION|SCHEMABINDING, ...</span>
<span class="org-keyword">AS</span>
<span class="org-keyword">RETURN</span>
(
    <span class="org-comment">-- Add the SELECT statement with parameter references here</span>
    <span class="org-keyword">SELECT</span> <span class="org-variable-name">@</span>$2 <span class="org-keyword">AS</span> c1
    $0
);
<span class="org-doc">go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Example to execute function</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">SELECT</span> *
<span class="org-keyword">FROM</span> $1 <span class="org-comment-delimiter">/* </span><span class="org-comment">owner.inline_function_name */</span>
    (<span class="org-comment-delimiter">/* </span><span class="org-comment">value_for_@parameter_name */</span>)
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1dd892f" class="outline-5">
<h5 id="org1dd892f">[ctf] Create Multi-Statement Table Function</h5>
<div class="outline-text-5" id="text-org1dd892f">
<p>
Creates a multi-statement table function.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> multi-stateme...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (N<span class="org-string">'${1:[schema].[table_function_name]}'</span>, N<span class="org-string">'TF'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">FUNCTION</span> $1;
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">FUNCTION</span> $1 (<span class="org-variable-name">@</span>{2:<span class="org-keyword">parameter_name</span>} ${3:parameter_data_type})
<span class="org-keyword">RETURNS</span> <span class="org-variable-name">@</span>${4:return_variable_name} <span class="org-keyword">TABLE</span>
(
    <span class="org-comment-delimiter">/* </span><span class="org-comment">table type definition */</span>
    $2 $3
)
<span class="org-comment">--WITH ENCRYPTION|SCHEMABINDING, ...</span>
<span class="org-keyword">AS</span>
<span class="org-keyword">BEGIN</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">function body */</span>
    <span class="org-keyword">INSERT</span> <span class="org-variable-name">@</span>$4
    <span class="org-keyword">SELECT</span> 1
    <span class="org-keyword">RETURN</span>
<span class="org-keyword">END</span>;
<span class="org-doc">go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Example to execute function</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> $1 <span class="org-comment-delimiter">/* </span><span class="org-comment">owner.table_function_name */</span>
    (<span class="org-comment-delimiter">/* </span><span class="org-comment">value_for_@parameter_name */</span>)
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org767b377" class="outline-5">
<h5 id="org767b377">[csf] Create Scalar Function</h5>
<div class="outline-text-5" id="text-org767b377">
<p>
Creates a scalar function.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> scalar <span class="org-keyword">function</span>
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (N<span class="org-string">'${1:[schema].[scalar_function_name]}'</span>, N<span class="org-string">'FN'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">FUNCTION</span> $1;
<span class="org-doc">go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-doc">SET ANSI_NULLS ON</span>
<span class="org-doc">go</span>
<span class="org-doc">SET QUOTED_IDENTIFIER ON</span>
<span class="org-doc">go</span>
<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Author:      /* Author */</span>
<span class="org-comment">-- Create date: /* Create Date */</span>
<span class="org-comment">-- Description: /* Description */</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">FUNCTION</span> $1 (<span class="org-variable-name">@</span>{2:<span class="org-keyword">parameter_name</span>} ${3:parameter_data_type})
<span class="org-keyword">RETURNS</span> ${4:function_data_type}
<span class="org-comment">--WITH ENCRYPTION|SCHEMABINDING, ...</span>
<span class="org-keyword">AS</span>
<span class="org-comment">-- Returns ...</span>
<span class="org-keyword">BEGIN</span>
    <span class="org-comment-delimiter">/* </span><span class="org-comment">function body */</span>
<span class="org-comment">--  eg.</span>
<span class="org-comment">--  DECLARE @v_ret $4</span>
<span class="org-comment">--  SELECT @v_ret = /* scalar expression */</span>
<span class="org-comment">--  RETURN @v_ret$0</span>
<span class="org-keyword">END</span>;
<span class="org-doc">go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Example to execute function</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">SELECT</span> $1 <span class="org-comment-delimiter">/* </span><span class="org-comment">owner.scalar_function_name */</span>
    (<span class="org-comment-delimiter">/* </span><span class="org-comment">value_for_@parameter_name */</span>)
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0c1f871" class="outline-5">
<h5 id="org0c1f871">[af] Alter Function</h5>
<div class="outline-text-5" id="text-org0c1f871">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">ALTER</span> <span class="org-keyword">FUNCTION</span> fr...
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">FUNCTION</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org6bc6ea0" class="outline-5">
<h5 id="org6bc6ea0">[dfn] Drop Function</h5>
<div class="outline-text-5" id="text-org6bc6ea0">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">function</span>
# <span class="org-comment">--</span>
<span class="org-keyword">DROP</span> <span class="org-keyword">FUNCTION</span> $0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgff1261d" class="outline-4">
<h4 id="orgff1261d">Help</h4>
<div class="outline-text-4" id="text-orgff1261d">
</div>
<div id="outline-container-org2ca51d6" class="outline-5">
<h5 id="org2ca51d6">[d] Describe object</h5>
<div class="outline-text-5" id="text-org2ca51d6">
<p>
List or describe database objects. Calls <code>sp_help</code>.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Describe</span> <span class="org-type">object</span>
# <span class="org-comment">--</span>
<span class="org-keyword">EXEC</span> sp_help <span class="org-string">'${1:object}'</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbae41a7" class="outline-5">
<h5 id="orgbae41a7">[ld] List Databases</h5>
<div class="outline-text-5" id="text-orgbae41a7">
<p>
List databases.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: List Databases
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
    <span class="org-keyword">name</span>,
    create_date,
    compatibility_level,
    <span class="org-keyword">collation_name</span>
<span class="org-keyword">FROM</span> sys.databases
<span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>;
</pre>
</div>

<p>
A <b>collation</b> consists of an enumeration of data and their equivalence to deduce
therefrom the processing behavior of the strings especially in the <b>comparison</b>
and <b>sorting</b> operations.
</p>

<ul class="org-ul">
<li><b>Code Page --</b> 1-4 digit number specifying code page.</li>
<li><b>Case Sensitivity --</b> CS = case sensitive, CI = insensitive.</li>
<li><b>Accent Sensitivity --</b> AI = accent insensitive, AS = accent sensitive.</li>
</ul>

<p>
Collation <code>SQL_Latin1_General_CP1_CI_AI</code>:
</p>

<ul class="org-ul">
<li>CP1 = Code Page 1252, that is Latin(ANSI).</li>
<li>Case-Insensitive.</li>
<li>Accent-Insensitive.</li>
</ul>
</div>
</div>

<div id="outline-container-orgb892674" class="outline-5">
<h5 id="orgb892674">[lf] List Functions</h5>
<div class="outline-text-5" id="text-orgb892674">
<p>
List functions.
</p>
</div>
</div>

<div id="outline-container-org5444d89" class="outline-5">
<h5 id="org5444d89">[li] List Indexes</h5>
<div class="outline-text-5" id="text-org5444d89">
<p>
List indexes.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: List Indexes
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
    t.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> TableName,
    i.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> IndexName,
    col.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> ColumnName,
    i.index_id                          <span class="org-keyword">AS</span> IndexId,
    ic.index_column_id                  <span class="org-keyword">AS</span> ColumnId
<span class="org-keyword">FROM</span> sys.indexes                        i
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.index_columns            ic
    <span class="org-keyword">ON</span> i.<span class="org-builtin">object_id</span> = ic.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> i.index_id = ic.index_id
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.columns                  col
    <span class="org-keyword">ON</span> ic.<span class="org-builtin">object_id</span> = col.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> ic.column_id = col.column_id
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.tables                   t
    <span class="org-keyword">ON</span> i.<span class="org-builtin">object_id</span> = t.<span class="org-builtin">object_id</span>
<span class="org-keyword">WHERE</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">i.is_primary_key = 0</span>
<span class="org-comment">    AND i.is_unique = 0</span>
<span class="org-comment">    AND i.is_unique_constraint = 0</span>
<span class="org-comment">    AND */</span> t.is_ms_shipped = 0
    <span class="org-keyword">AND</span> i.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>                <span class="org-comment">-- Index name.</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    t.<span class="org-keyword">name</span>,
    i.<span class="org-keyword">name</span>,
    i.index_id,
    ic.index_column_id;
</pre>
</div>

<p>
<b>Comma-separated list</b> of index columns:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- List Indexes (for SQL Server).  Idem as above, with columns concatenated per index.</span>
<span class="org-keyword">SELECT</span>
    <span class="org-comment">-- SCHEMA_NAME(t.schema_id)            AS "schema",</span>
    t.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> <span class="org-keyword">table_name</span>,
    i.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> index_name,
    <span class="org-builtin">SUBSTRING</span>(column_names, 1, <span class="org-builtin">LEN</span>(column_names) - 1) <span class="org-keyword">AS</span> columns,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 1                 <span class="org-keyword">THEN</span> <span class="org-string">'Clustered index'</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 2                 <span class="org-keyword">THEN</span> <span class="org-string">'Nonclustered unique index'</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 3                 <span class="org-keyword">THEN</span> <span class="org-string">'XML index'</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 4                 <span class="org-keyword">THEN</span> <span class="org-string">'Spatial index'</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 5                 <span class="org-keyword">THEN</span> <span class="org-string">'Clustered columnstore index'</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 6                 <span class="org-keyword">THEN</span> <span class="org-string">'Nonclustered columnstore index'</span>
        <span class="org-keyword">WHEN</span> i.<span class="org-keyword">type</span> = 7                 <span class="org-keyword">THEN</span> <span class="org-string">'Nonclustered hash index'</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> index_type,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> i.is_unique = 1            <span class="org-keyword">THEN</span> <span class="org-string">'Unique'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">'Not unique'</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> "<span class="org-keyword">unique</span>"
<span class="org-keyword">FROM</span> sys.objects                        t
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.indexes                  i
    <span class="org-keyword">ON</span> t.<span class="org-builtin">object_id</span> = i.<span class="org-builtin">object_id</span>
<span class="org-keyword">CROSS</span> APPLY
(
    <span class="org-keyword">SELECT</span> col.<span class="org-keyword">name</span> + <span class="org-string">', '</span>
    <span class="org-keyword">FROM</span> sys.index_columns              ic
    <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.columns              col
        <span class="org-keyword">ON</span> ic.<span class="org-builtin">object_id</span> = col.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> ic.column_id = col.column_id
    <span class="org-keyword">WHERE</span> ic.<span class="org-builtin">object_id</span> = t.<span class="org-builtin">object_id</span>
        <span class="org-keyword">AND</span> ic.index_id = i.index_id
    <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> index_column_id
    <span class="org-keyword">FOR</span> XML <span class="org-keyword">PATH</span>(<span class="org-string">''</span>)
)                                       D(column_names)
<span class="org-keyword">WHERE</span> t.is_ms_shipped = 0
    <span class="org-keyword">AND</span> index_id &gt; 0
    <span class="org-keyword">AND</span> i.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>                <span class="org-comment">-- Index name.</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    t.<span class="org-keyword">name</span>,
    i.<span class="org-keyword">name</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- List Indexes (for Oracle).</span>
<span class="org-keyword">SELECT</span>
    ind.owner                           <span class="org-keyword">AS</span> INDEX_OWNER,
    ind.<span class="org-keyword">table_name</span>,
    ind.index_name,
    ind_col.<span class="org-keyword">column_name</span>,
    ind_col.column_position,
    ind.uniqueness
<span class="org-keyword">FROM</span> sys.all_indexes                    ind
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.all_ind_columns          ind_col
    <span class="org-keyword">ON</span> ind.owner = ind_col.index_owner
        <span class="org-keyword">AND</span> ind.index_name = ind_col.index_name
<span class="org-comment">-- Exclude (some) Oracle default schemas.</span>
<span class="org-keyword">WHERE</span>
    ind.owner <span class="org-keyword">NOT</span> <span class="org-keyword">IN</span> (<span class="org-string">'CTXSYS'</span>, <span class="org-string">'MDSYS'</span>, <span class="org-string">'SYS'</span>, <span class="org-string">'SYSTEM'</span>, <span class="org-string">'XDB'</span>)
    <span class="org-keyword">AND</span> ind.index_name <span class="org-keyword">LIKE</span> <span class="org-builtin">UPPER</span>(<span class="org-string">'%%'</span>)
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    ind.table_owner,
    ind.<span class="org-keyword">table_name</span>,
    ind.index_name,
    ind_col.column_position;
</pre>
</div>

<p>
Comma-separated list of index columns:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- List Indexes (for Oracle).  Idem as above, with columns concatenated per index.</span>
<span class="org-keyword">SELECT</span>
    aic.index_owner,
    aic.<span class="org-keyword">table_name</span>,
    aic.index_name,
    LISTAGG(aic.<span class="org-keyword">column_name</span>, <span class="org-string">', '</span>)
        WITHIN <span class="org-keyword">GROUP</span> (<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> aic.column_position) <span class="org-keyword">AS</span> COLS
<span class="org-keyword">FROM</span> all_ind_columns                    aic
<span class="org-comment">-- Exclude (some) Oracle default schemas.</span>
<span class="org-keyword">WHERE</span>
    aic.index_owner <span class="org-keyword">NOT</span> <span class="org-keyword">IN</span> (<span class="org-string">'CTXSYS'</span>, <span class="org-string">'MDSYS'</span>, <span class="org-string">'SYS'</span>, <span class="org-string">'SYSTEM'</span>, <span class="org-string">'XDB'</span>)
    <span class="org-keyword">AND</span> aic.index_name <span class="org-keyword">LIKE</span> <span class="org-builtin">UPPER</span>(<span class="org-string">'%%'</span>)
<span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span>
    aic.index_owner,
    aic.<span class="org-keyword">table_name</span>,
    aic.index_name
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    aic.index_owner,
    aic.<span class="org-keyword">table_name</span>,
    aic.index_name;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbd57f95" class="outline-5">
<h5 id="orgbd57f95">List missing indexes</h5>
<div class="outline-text-5" id="text-orgbd57f95">
<p>
SQL script to <b>help identifying</b> ways to increase performance based on the most
commonly-run queries.
</p>

<p>
It analyzes the recent queries that have been run, and suggests database indexes
that could be added in order to speed them up. Aside from just straight
<b>re-building primary key indexes</b>, this is the best tool we&rsquo;ve seen for <b>speeding
up performance</b> in SQL Server queries, <b>from minutes down to seconds</b>.
</p>

<div class="warning">
<p>
Each database has different volumes of data on each table in their environment,
and <b>adding too many indexes to a database can drastically reduce its
performance</b>.  Hence, a DBA should look at the use cases for an environment and
what tables those uses cases cover, and figure out effective indexes to put on
the database.
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For SQL Server.</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 25
    <span class="org-comment">-- An estimate of the overall value of this index</span>
    <span class="org-builtin">CAST</span>(user_seeks * avg_total_user_cost * (avg_user_impact * 0.01) <span class="org-keyword">AS</span> <span class="org-type">INT</span>) <span class="org-keyword">AS</span> [index_advantage],
    <span class="org-comment">-- The last time another seek was added to this row.</span>
    migs.last_user_seek,
    mid.[<span class="org-keyword">statement</span>]                     <span class="org-keyword">AS</span> [<span class="org-keyword">Database</span>.<span class="org-keyword">Schema</span>.<span class="org-keyword">Table</span>],
    <span class="org-comment">-- Columns that were part of an exact comparison</span>
    mid.equality_columns,
    <span class="org-comment">-- Columns that were part on any other comparison including &lt;, &gt;, &lt;&gt;, or BETWEEN</span>
    mid.inequality_columns,
    <span class="org-comment">-- Columns return, but not part of a comparison</span>
    mid.included_columns,
    <span class="org-comment">-- Number of times this index would have been used if it had existed</span>
    migs.user_seeks,
    <span class="org-comment">-- Cost of query without the index</span>
    migs.avg_total_user_cost,
    <span class="org-comment">-- Estimated improvment of previous column cost if this index is created</span>
    migs.avg_user_impact,
    <span class="org-string">'CREATE INDEX IX_'</span> + <span class="org-keyword">LEFT</span>(<span class="org-keyword">RIGHT</span>(mid.<span class="org-keyword">STATEMENT</span>, <span class="org-builtin">CHARINDEX</span>(<span class="org-string">'['</span>, <span class="org-builtin">REVERSE</span>(mid.[<span class="org-keyword">statement</span>]))-1), <span class="org-builtin">LEN</span>(<span class="org-keyword">RIGHT</span>(mid.<span class="org-keyword">STATEMENT</span>, <span class="org-builtin">CHARINDEX</span>(<span class="org-string">'['</span>, <span class="org-builtin">REVERSE</span>(mid.[<span class="org-keyword">statement</span>]))-1))-1) + <span class="org-string">'_'</span>
    + <span class="org-keyword">CASE</span>
          <span class="org-keyword">WHEN</span> mid.inequality_columns <span class="org-keyword">IS</span> <span class="org-keyword">NULL</span> <span class="org-keyword">THEN</span> <span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(mid.equality_columns, <span class="org-string">', '</span>, <span class="org-string">'_'</span>), <span class="org-string">'['</span>, <span class="org-string">''</span>), <span class="org-string">']'</span>, <span class="org-string">''</span>)
          <span class="org-keyword">WHEN</span> mid.equality_columns <span class="org-keyword">IS</span> <span class="org-keyword">NULL</span> <span class="org-keyword">THEN</span> <span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(mid.inequality_columns, <span class="org-string">', '</span>, <span class="org-string">'_'</span>), <span class="org-string">'['</span>, <span class="org-string">''</span>), <span class="org-string">']'</span>, <span class="org-string">''</span>)
          <span class="org-keyword">ELSE</span> <span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(mid.equality_columns, <span class="org-string">', '</span>, <span class="org-string">'_'</span>), <span class="org-string">'['</span>, <span class="org-string">''</span>), <span class="org-string">']'</span>, <span class="org-string">''</span>) + <span class="org-string">'_'</span> + <span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(<span class="org-builtin">REPLACE</span>(mid.inequality_columns, <span class="org-string">', '</span>, <span class="org-string">'_'</span>), <span class="org-string">'['</span>, <span class="org-string">''</span>), <span class="org-string">']'</span>, <span class="org-string">''</span>)
      <span class="org-keyword">END</span> + <span class="org-string">' ON '</span> + mid.<span class="org-keyword">STATEMENT</span> + <span class="org-string">' ('</span>
    + <span class="org-keyword">CASE</span>
          <span class="org-keyword">WHEN</span> mid.inequality_columns <span class="org-keyword">IS</span> <span class="org-keyword">NULL</span> <span class="org-keyword">THEN</span> mid.equality_columns
          <span class="org-keyword">WHEN</span> mid.equality_columns <span class="org-keyword">IS</span> <span class="org-keyword">NULL</span> <span class="org-keyword">THEN</span> mid.inequality_columns
          <span class="org-keyword">ELSE</span> mid.equality_columns + <span class="org-string">', '</span> + mid.inequality_columns
      <span class="org-keyword">END</span> + <span class="org-string">')'</span>
    + <span class="org-keyword">CASE</span>
          <span class="org-keyword">WHEN</span> <span class="org-builtin">ISNULL</span>(mid.included_columns, <span class="org-string">''</span>) &lt;&gt; <span class="org-string">''</span> <span class="org-keyword">THEN</span> <span class="org-string">' INCLUDE ('</span> + mid.included_columns + <span class="org-string">')'</span>
          <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
      <span class="org-keyword">END</span>                               <span class="org-keyword">AS</span> CREATE_STATEMENT
<span class="org-keyword">FROM</span> sys.dm_db_missing_index_group_stats migs
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.dm_db_missing_index_groups mig
    <span class="org-keyword">ON</span> migs.group_handle = mig.index_group_handle
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.dm_db_missing_index_details mid
    <span class="org-keyword">ON</span> mig.index_handle = mid.index_handle
<span class="org-keyword">WHERE</span> mid.database_id = <span class="org-builtin">DB_ID</span>()
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> index_advantage <span class="org-keyword">DESC</span>;
</pre>
</div>

<p>
Script to create missing indexes on all FK columns.  (<b>WARNING --</b> For performance
reason, not all FK need to be indexed!)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For Oracle.</span>
<span class="org-comment">-- BUG: Does not handle properly index names on multiple columns.</span>
<span class="org-keyword">SELECT</span> <span class="org-string">'CREATE INDEX '</span> || fk.<span class="org-keyword">table_name</span> || <span class="org-string">'_'</span> || columns || <span class="org-string">' on '</span> || fk.<span class="org-keyword">table_name</span> || <span class="org-string">'('</span> || columns || <span class="org-string">');'</span> SQL_QUERY
   <span class="org-comment">-- TABLESPACE afm_ndx; ' --,</span>
    ,all_tables.num_rows
   <span class="org-comment">--    , fk.*</span>
<span class="org-keyword">FROM</span> (<span class="org-keyword">SELECT</span> DECODE (b.<span class="org-keyword">table_name</span>, <span class="org-keyword">NULL</span>, <span class="org-string">'&lt;missing&gt;'</span>, <span class="org-string">'ok'</span>) status,
             a.<span class="org-keyword">table_name</span>,
             a.columns,
             b.columns col_index
      <span class="org-keyword">FROM</span> (<span class="org-keyword">SELECT</span> substr (a.<span class="org-keyword">table_name</span>, 1, 30) <span class="org-keyword">table_name</span>,
                   substr (a.<span class="org-keyword">constraint_name</span>, 1, 30) <span class="org-keyword">constraint_name</span>,
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 1, substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 2, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 3, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 4, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 5, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 6, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 7, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 8, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 9, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 10, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 11, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 12, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 13, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 14, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 15, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (<span class="org-keyword">position</span>, 16, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) columns
            <span class="org-keyword">FROM</span> user_cons_columns a,
                 user_constraints b
            <span class="org-keyword">WHERE</span> a.<span class="org-keyword">constraint_name</span> = b.<span class="org-keyword">constraint_name</span> <span class="org-keyword">AND</span> b.constraint_type = <span class="org-string">'R'</span>
            <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> substr (a.<span class="org-keyword">table_name</span>, 1, 30),
                     substr (a.<span class="org-keyword">constraint_name</span>, 1, 30)
           ) a,
           (<span class="org-keyword">SELECT</span> substr (<span class="org-keyword">table_name</span>, 1, 30) <span class="org-keyword">table_name</span>,
                   substr (index_name, 1, 30) index_name,
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 1, substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 2, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 3, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 4, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 5, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 6, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 7, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 8, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 9, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 10, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 11, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 12, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 13, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 14, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 15, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) ||
                   <span class="org-keyword">MAX</span> (DECODE (column_position, 16, <span class="org-string">', '</span> || substr (<span class="org-keyword">column_name</span>, 1, 30), <span class="org-keyword">NULL</span>)) columns
            <span class="org-keyword">FROM</span> user_ind_columns
            <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> substr (<span class="org-keyword">table_name</span>, 1, 30),
                     substr (index_name, 1, 30)
           ) b
      <span class="org-keyword">WHERE</span> a.<span class="org-keyword">table_name</span> = b.<span class="org-keyword">table_name</span> (+) <span class="org-keyword">AND</span> b.columns (+) <span class="org-keyword">LIKE</span> a.columns || <span class="org-string">'%'</span>
     ) fk,
     all_tables
<span class="org-keyword">WHERE</span> fk.<span class="org-keyword">table_name</span> = all_tables.<span class="org-keyword">table_name</span>
  <span class="org-keyword">AND</span> fk.<span class="org-keyword">table_name</span> <span class="org-keyword">LIKE</span> <span class="org-builtin">UPPER</span>(<span class="org-string">'%%'</span>)
  <span class="org-keyword">AND</span> fk.status = <span class="org-string">'&lt;missing&gt;'</span>
  <span class="org-keyword">AND</span> num_rows != 0
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> fk.<span class="org-keyword">table_name</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a6a55a" class="outline-5">
<h5 id="org4a6a55a">List redundant indexes</h5>
<div class="outline-text-5" id="text-org4a6a55a">
<p>
<a href="https://dzone.com/articles/how-to-find-redundant-indexes-in-sql">https://dzone.com/articles/how-to-find-redundant-indexes-in-sql</a>
</p>

<p>
Don&rsquo;t apply this advice in read-heavy, write-rarely databases.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For SQL Server.</span>
<span class="org-keyword">WITH</span> i
<span class="org-keyword">AS</span>
(
    <span class="org-keyword">SELECT</span>
        t.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> <span class="org-keyword">table_name</span>,
        i.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> index_name,
        c.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> <span class="org-keyword">column_name</span>,
        ic.index_column_id
    <span class="org-keyword">FROM</span> sys.indexes                    i
    <span class="org-keyword">JOIN</span> sys.index_columns              ic
        <span class="org-keyword">ON</span> i.<span class="org-builtin">object_id</span> = ic.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> i.index_id = ic.index_id
    <span class="org-keyword">JOIN</span> sys.columns                    c
        <span class="org-keyword">ON</span> ic.<span class="org-builtin">object_id</span> = c.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> ic.column_id = c.column_id
    <span class="org-keyword">JOIN</span> sys.tables                     t
        <span class="org-keyword">ON</span> i.<span class="org-builtin">object_id</span> = t.<span class="org-builtin">object_id</span>
),

indexes
<span class="org-keyword">AS</span>
(
    <span class="org-keyword">SELECT</span>
        <span class="org-keyword">table_name</span>,
        index_name,
        <span class="org-builtin">STUFF</span>((
                  <span class="org-keyword">SELECT</span> <span class="org-string">','</span> + j.<span class="org-keyword">column_name</span>
                  <span class="org-keyword">FROM</span> i j
                  <span class="org-keyword">WHERE</span> i.<span class="org-keyword">table_name</span> = j.<span class="org-keyword">table_name</span>
                        <span class="org-keyword">AND</span> i.index_name = j.index_name
                  <span class="org-keyword">FOR</span> XML <span class="org-keyword">PATH</span>(<span class="org-string">''</span>)      <span class="org-comment">-- Yay, XML in SQL!</span>
              ), 1, 1, <span class="org-string">''</span>)              <span class="org-keyword">AS</span> columns
    <span class="org-keyword">FROM</span> i
    <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span>
        <span class="org-keyword">table_name</span>,
        index_name
)

<span class="org-keyword">SELECT</span>
    i.<span class="org-keyword">table_name</span>,
    i.index_name                        <span class="org-keyword">AS</span> "Deletion candidate <span class="org-keyword">index</span>",
    i.columns                           <span class="org-keyword">AS</span> "Deletion candidate columns",
    j.index_name                        <span class="org-keyword">AS</span> "<span class="org-keyword">Existing</span> <span class="org-keyword">index</span>",
    j.columns                           <span class="org-keyword">AS</span> "<span class="org-keyword">Existing</span> columns"
<span class="org-keyword">FROM</span> indexes                            i
<span class="org-keyword">JOIN</span> indexes                            j
    <span class="org-keyword">ON</span> i.<span class="org-keyword">table_name</span> = j.<span class="org-keyword">table_name</span> <span class="org-keyword">AND</span> j.columns <span class="org-keyword">LIKE</span> i.columns + <span class="org-string">',%'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For Oracle.</span>
<span class="org-keyword">WITH</span> indexes
<span class="org-keyword">AS</span>
(
    <span class="org-keyword">SELECT</span>
        i.index_name,
        i.<span class="org-keyword">table_name</span>,
        LISTAGG(c.<span class="org-keyword">column_name</span>, <span class="org-string">', '</span>)
            WITHIN <span class="org-keyword">GROUP</span> (<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> c.column_position) <span class="org-keyword">AS</span> columns
    <span class="org-keyword">FROM</span> all_indexes                    i
         <span class="org-keyword">JOIN</span> all_ind_columns c <span class="org-keyword">ON</span> i.index_name = c.index_name
    <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span>
        i.<span class="org-keyword">table_name</span>,
        i.index_name,
        i.leaf_blocks
)

<span class="org-keyword">SELECT</span>
    i.<span class="org-keyword">table_name</span>,
    i.index_name                        <span class="org-keyword">AS</span> "Deletion candidate <span class="org-keyword">index</span>",
    i.columns                           <span class="org-keyword">AS</span> "Deletion candidate columns",
    j.index_name                        <span class="org-keyword">AS</span> "<span class="org-keyword">Existing</span> <span class="org-keyword">index</span>",
    j.columns                           <span class="org-keyword">AS</span> "<span class="org-keyword">Existing</span> columns"
<span class="org-keyword">FROM</span> indexes                            i
<span class="org-keyword">JOIN</span> indexes                            j
    <span class="org-keyword">ON</span> i.<span class="org-keyword">table_name</span> = j.<span class="org-keyword">table_name</span> <span class="org-keyword">AND</span> j.columns <span class="org-keyword">LIKE</span> i.columns || <span class="org-string">',%'</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org6506171" class="outline-5">
<h5 id="org6506171">List unused indexes</h5>
<div class="outline-text-5" id="text-org6506171">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-doc">USE MASTER;</span>
<span class="org-doc">GO</span>
<span class="org-keyword">GRANT</span> <span class="org-keyword">VIEW</span> SERVER <span class="org-keyword">STATE</span> <span class="org-keyword">TO</span> afm;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-builtin">OBJECT_NAME</span>(s.<span class="org-builtin">object_id</span>)            <span class="org-keyword">AS</span> <span class="org-keyword">table_name</span>,
    i.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> index_name,
    i.index_id,
    user_seeks + user_scans + user_lookups <span class="org-keyword">AS</span> <span class="org-keyword">reads</span>,
    user_updates                        <span class="org-keyword">AS</span> writes,
    <span class="org-keyword">SUM</span>(p.<span class="org-keyword">rows</span>)                         <span class="org-keyword">AS</span> <span class="org-keyword">rows</span>,
    last_user_update
<span class="org-keyword">FROM</span> sys.dm_db_index_usage_stats        s
<span class="org-keyword">JOIN</span> sys.indexes                        i
    <span class="org-keyword">ON</span> s.<span class="org-builtin">object_id</span> = i.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> i.index_id = s.index_id
<span class="org-keyword">JOIN</span> sys.partitions                     p
    <span class="org-keyword">ON</span> s.<span class="org-builtin">object_id</span> = p.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> p.index_id = s.index_id
<span class="org-keyword">WHERE</span> <span class="org-builtin">OBJECTPROPERTY</span>(s.<span class="org-builtin">object_id</span>, <span class="org-string">'IsUserTable'</span>) = 1
    <span class="org-keyword">AND</span> s.index_id &gt; 0
    <span class="org-keyword">AND</span> s.database_id = <span class="org-builtin">DB_ID</span>() <span class="org-comment">-- Database ID of the current database.</span>
    <span class="org-keyword">AND</span> user_seeks + user_scans + user_lookups = 0
<span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span>
    <span class="org-builtin">OBJECT_NAME</span>(s.<span class="org-builtin">object_id</span>),
    i.<span class="org-keyword">name</span>,
    i.index_id,
    user_seeks + user_scans + user_lookups,
    user_updates,
    last_user_update
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    writes <span class="org-keyword">DESC</span>,
    <span class="org-keyword">reads</span> <span class="org-keyword">ASC</span>;
</pre>
</div>

<p>
If you see indexes where:
</p>

<ul class="org-ul">
<li>there are no seeks, scans or lookups, but</li>
<li>there are updates,</li>
</ul>

<p>
this means that SQL Server has not used the index to satisfy a query but still
needs to maintain the index.
</p>

<div class="tip">
<p>
Remember that the data from these DMVs is reset when SQL Server is restarted, so
make sure you have collected data for a long enough period of time to determine
which indexes may be good candidates to be dropped.
</p>

</div>
</div>
</div>

<div id="outline-container-org80206c5" class="outline-5">
<h5 id="org80206c5">[ll] List Logins</h5>
<div class="outline-text-5" id="text-org80206c5">
<p>
List logins and associated roles.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: List Logins
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
    <span class="org-keyword">name</span>,
    type_desc,
    default_database_name,
    <span class="org-keyword">type</span>,
    create_date
<span class="org-keyword">FROM</span> sys.server_principals
<span class="org-keyword">WHERE</span> type_desc = <span class="org-string">'SQL_LOGIN'</span>
    <span class="org-keyword">AND</span> <span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> <span class="org-keyword">name</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e12e93" class="outline-5">
<h5 id="org5e12e93">[ls] List Schemas</h5>
<div class="outline-text-5" id="text-org5e12e93">
<p>
List schemas.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: List Schemas
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
    <span class="org-keyword">name</span>,
    schema_id,
    principal_id
<span class="org-keyword">FROM</span> sys.schemas
<span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3cb8b1e" class="outline-5">
<h5 id="org3cb8b1e">[lt] List Tables</h5>
<div class="outline-text-5" id="text-org3cb8b1e">
<p>
List tables.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: List Tables
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
    TABLE_CATALOG,
    TABLE_SCHEMA,
    <span class="org-keyword">TABLE_NAME</span>,
    TABLE_TYPE
<span class="org-keyword">FROM</span> INFORMATION_SCHEMA.TABLES
<span class="org-keyword">WHERE</span> TABLE_TYPE = <span class="org-string">'BASE TABLE'</span>
    <span class="org-keyword">AND</span> <span class="org-keyword">TABLE_NAME</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4a69518" class="outline-5">
<h5 id="org4a69518">[lv] List Views</h5>
<div class="outline-text-5" id="text-org4a69518">
<p>
List views.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: List Views
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span>
    table_catalog <span class="org-keyword">AS</span> <span class="org-keyword">catalog</span>,
    TABLE_SCHEMA <span class="org-keyword">AS</span> <span class="org-keyword">schema_name</span>,
    <span class="org-keyword">TABLE_NAME</span> <span class="org-keyword">AS</span> view_name
<span class="org-keyword">FROM</span> INFORMATION_SCHEMA.VIEWS
<span class="org-keyword">WHERE</span> <span class="org-keyword">TABLE_NAME</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>;

<span class="org-comment">-- SELECT owner, view_name</span>
<span class="org-comment">-- FROM sys.all_views</span>
<span class="org-comment">-- WHERE owner = 'AFM'</span>
<span class="org-comment">--     AND view_name LIKE '%%';</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf036f6c" class="outline-5">
<h5 id="orgf036f6c">[sf] Show Function</h5>
<div class="outline-text-5" id="text-orgf036f6c">
<p>
Show a function&rsquo;s definition.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Show <span class="org-keyword">Function</span>
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> OBJECT_DEFINITION(<span class="org-builtin">OBJECT_ID</span>(<span class="org-string">'${1:funcname}'</span>));
</pre>
</div>
</div>
</div>

<div id="outline-container-org6a43826" class="outline-5">
<h5 id="org6a43826">[sis] Search In Sources</h5>
<div class="outline-text-5" id="text-org6a43826">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Search</span> <span class="org-keyword">In</span> Sources
# <span class="org-comment">--</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-comment">This is an easy way to look through the sources of all objects in the database</span>
<span class="org-comment">if you need to find particular string. This script can be used, for example,</span>
<span class="org-comment">to find references of some specific object by other objects. Depending on the</span>
<span class="org-comment">size of your database you might want to limit the search scope to particular</span>
<span class="org-comment">object type. Just comment unneeded object types in WHERE statement.</span>
<span class="org-comment">Enter search string between %% marks in @SearchPattern initialisation statement.</span>
<span class="org-comment">When you get the results you can copy object name from "FullName" column and</span>
<span class="org-comment">use SSMSBoost to quickly locate it in the object explorer, or you can continue</span>
<span class="org-comment">searching in results using "Find in ResultsGrid" function.</span>

<span class="org-comment">This script is provided to you by SSMSBoost as is. Improvements and comments are welcome.</span>
<span class="org-comment">Redistribution with reference to SSMSBoost project website is welcome.</span>
<span class="org-comment">SSMSBoost team, 2014</span>
<span class="org-comment">*/</span>
<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@SearchPattern</span> <span class="org-type">NVARCHAR</span>(128)

<span class="org-keyword">SET</span> <span class="org-variable-name">@SearchPattern</span> = <span class="org-string">'%$0%'</span>

<span class="org-keyword">SELECT</span>
    <span class="org-keyword">SCHEMA_NAME</span>(o.schema_id) <span class="org-keyword">AS</span> [<span class="org-keyword">schema</span>],
    o.[<span class="org-keyword">name</span>],
    o.<span class="org-keyword">type</span>,
    <span class="org-string">'['</span> + <span class="org-keyword">SCHEMA_NAME</span>(o.schema_id) + <span class="org-string">'].['</span> + o.[<span class="org-keyword">name</span>] + <span class="org-string">']'</span> <span class="org-keyword">AS</span> [FullName],
    OBJECT_DEFINITION(<span class="org-builtin">object_id</span>) <span class="org-keyword">AS</span> [<span class="org-keyword">Source</span>]
<span class="org-keyword">FROM</span> sys.objects <span class="org-keyword">AS</span> o
<span class="org-keyword">WHERE</span> <span class="org-builtin">LOWER</span>(OBJECT_DEFINITION(o.<span class="org-builtin">object_id</span>)) <span class="org-keyword">LIKE</span> <span class="org-builtin">LOWER</span>(<span class="org-variable-name">@SearchPattern</span>)
    <span class="org-keyword">AND</span> o.<span class="org-keyword">type</span> <span class="org-keyword">IN</span> (
    <span class="org-string">'C'</span>, <span class="org-comment">--- = Check constraint</span>
    <span class="org-string">'D'</span>, <span class="org-comment">--- = Default (constraint or stand-alone)</span>
    <span class="org-string">'P'</span>, <span class="org-comment">--- = SQL stored procedure</span>
    <span class="org-string">'FN'</span>, <span class="org-comment">--- = SQL scalar function</span>
    <span class="org-string">'R'</span>, <span class="org-comment">--- = Rule</span>
    <span class="org-string">'RF'</span>, <span class="org-comment">--- = Replication filter procedure</span>
    <span class="org-string">'TR'</span>, <span class="org-comment">--- = SQL trigger (schema-scoped DML trigger, or DDL trigger at either the database or server scope)</span>
    <span class="org-string">'IF'</span>, <span class="org-comment">--- = SQL inline table-valued function</span>
    <span class="org-string">'TF'</span>, <span class="org-comment">--- = SQL table-valued function</span>
    <span class="org-string">'V'</span>) <span class="org-comment">--- = View</span>
<span class="org-keyword">UNION</span> <span class="org-keyword">ALL</span>
<span class="org-keyword">SELECT</span>
    <span class="org-keyword">SCHEMA_NAME</span>(q.schema_id) <span class="org-keyword">AS</span> [<span class="org-keyword">schema</span>],
    q.[<span class="org-keyword">name</span>],
    <span class="org-string">'SQ'</span> <span class="org-keyword">AS</span> <span class="org-keyword">type</span>,
    <span class="org-string">'['</span> + <span class="org-keyword">SCHEMA_NAME</span>(q.schema_id) + <span class="org-string">'].['</span> + q.[<span class="org-keyword">name</span>] + <span class="org-string">']'</span> <span class="org-keyword">AS</span> [FullName],
    activation_procedure <span class="org-keyword">AS</span> [<span class="org-keyword">Source</span>]
<span class="org-keyword">FROM</span> sys.service_queues q
<span class="org-keyword">WHERE</span> q.activation_procedure <span class="org-keyword">LIKE</span> <span class="org-builtin">LOWER</span>(<span class="org-variable-name">@SearchPattern</span>)
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    o.<span class="org-keyword">type</span>,
    o.[<span class="org-keyword">name</span>];
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org342a361" class="outline-4">
<h4 id="org342a361">Index</h4>
<div class="outline-text-4" id="text-org342a361">
</div>
<div id="outline-container-org20dab44" class="outline-5">
<h5 id="org20dab44">[crunq] Create Unique Index</h5>
<div class="outline-text-5" id="text-org20dab44">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">unique</span> <span class="org-keyword">index</span>
# <span class="org-comment">--</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">UNIQUE</span> <span class="org-keyword">INDEX</span> unq_$0
<span class="org-keyword">ON</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7aaac7e" class="outline-5">
<h5 id="org7aaac7e">[cni] Create Non-Clustered Index (crnci)</h5>
<div class="outline-text-5" id="text-org7aaac7e">
<p>
Creates a basic, non-clustered index.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> non-<span class="org-keyword">unique</span> n...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span> <span class="org-keyword">FROM</span> sys.indexes <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'nci_${3:index_name}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">INDEX</span> nci_$3 <span class="org-keyword">ON</span> ${1:[<span class="org-keyword">schema</span>].[owner_name]};
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">NONCLUSTERED</span> <span class="org-keyword">INDEX</span> nci_$3
<span class="org-keyword">ON</span> $1 (${2:<span class="org-keyword">column</span>})
<span class="org-comment">--WITH PAD_INDEX</span>
<span class="org-comment">--    | FILLFACTOR = fillfactor</span>
<span class="org-comment">--    | IGNORE_DUP_KEY</span>
<span class="org-comment">--    | DROP_EXISTING</span>
<span class="org-comment">--    | STATISTICS_NORECOMPUTE</span>
<span class="org-comment">--    | SORT_IN_TEMPDB, .. as required</span>
<span class="org-comment">-- ON filegroup</span>
<span class="org-doc">go</span>
$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org512d0e4" class="outline-5">
<h5 id="org512d0e4">[cuni] Create Unique Non-Clustered Index</h5>
<div class="outline-text-5" id="text-org512d0e4">
<p>
Creates a unique, non-clustered index.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">unique</span> nonclu...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span> <span class="org-keyword">FROM</span> sys.indexes <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'unq_${3:index_name}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">INDEX</span> unq_$3 <span class="org-keyword">ON</span> ${1:[<span class="org-keyword">schema</span>].[owner_name]};
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">UNIQUE</span> <span class="org-keyword">NONCLUSTERED</span> <span class="org-keyword">INDEX</span> unq_$3
<span class="org-keyword">ON</span> $1 (${2:<span class="org-keyword">column</span>})
<span class="org-comment">--WITH</span>
<span class="org-comment">--    PAD_INDEX,</span>
<span class="org-comment">--    FILLFACTOR = fillfactor,</span>
<span class="org-comment">--    IGNORE_DUP_KEY,</span>
<span class="org-comment">--    DROP_EXISTING = OFF,</span>
<span class="org-comment">--    STATISTICS_NORECOMPUTE,</span>
<span class="org-comment">--    SORT_IN_TEMPDB = OFF, .. as required</span>
<span class="org-keyword">ON</span> ${4:<span class="org-builtin">filegroup_name</span>}
<span class="org-doc">go</span>
$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org1fe8d34" class="outline-5">
<h5 id="org1fe8d34">[cci] Create Clustered Index (crci)</h5>
<div class="outline-text-5" id="text-org1fe8d34">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> non-<span class="org-keyword">unique</span> cl...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span> <span class="org-keyword">FROM</span> sys.indexes <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'ci_${3:index_name}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">INDEX</span> ci_$3 <span class="org-keyword">ON</span> ${1:[<span class="org-keyword">schema</span>].[owner_name]};
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">CLUSTERED</span> <span class="org-keyword">INDEX</span> ci_$3
<span class="org-keyword">ON</span> $1 (${2:<span class="org-keyword">column</span>})
<span class="org-comment">--WITH PAD_INDEX</span>
<span class="org-comment">--    | FILLFACTOR = fillfactor</span>
<span class="org-comment">--    | IGNORE_DUP_KEY</span>
<span class="org-comment">--    | DROP_EXISTING</span>
<span class="org-comment">--    | STATISTICS_NORECOMPUTE</span>
<span class="org-comment">--    | SORT_IN_TEMPDB, .. as required</span>
<span class="org-comment">-- ON filegroup</span>
<span class="org-doc">go</span>
$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org46563c1" class="outline-5">
<h5 id="org46563c1">[cuci] Create Unique Clustered Index</h5>
<div class="outline-text-5" id="text-org46563c1">
<p>
Create index full syntax.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">unique</span> cluster...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> <span class="org-keyword">name</span> <span class="org-keyword">FROM</span> sys.indexes <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = N<span class="org-string">'unq_${3:index_name}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">INDEX</span> unq_$3 <span class="org-keyword">ON</span> ${1:[<span class="org-keyword">schema</span>].[owner_name]};
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">UNIQUE</span> <span class="org-keyword">CLUSTERED</span> <span class="org-keyword">INDEX</span> unq_$3
<span class="org-keyword">ON</span> $1 (${2:<span class="org-keyword">column</span>})
<span class="org-keyword">WITH</span>
PAD_INDEX,
<span class="org-keyword">FILLFACTOR</span> = ${5:fillfactor_value},
IGNORE_DUP_KEY,
DROP_EXISTING,
STATISTICS_NORECOMPUTE
<span class="org-comment">--    | SORT_IN_TEMPDB, .. as required</span>
<span class="org-keyword">ON</span> ${4:<span class="org-builtin">filegroup_name</span>}
<span class="org-doc">go</span>
$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ee760a" class="outline-5">
<h5 id="org5ee760a">[di] Drop Index</h5>
<div class="outline-text-5" id="text-org5ee760a">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">index</span>
# <span class="org-comment">--</span>
<span class="org-keyword">DROP</span> <span class="org-keyword">INDEX</span> $0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc41cbdf" class="outline-4">
<h4 id="orgc41cbdf">Join fragment</h4>
<div class="outline-text-4" id="text-orgc41cbdf">
</div>
<div id="outline-container-orgebcd1aa" class="outline-5">
<h5 id="orgebcd1aa">[j] Join</h5>
<div class="outline-text-5" id="text-orgebcd1aa">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org143af69" class="outline-5">
<h5 id="org143af69">[cj] Cross Join</h5>
<div class="outline-text-5" id="text-org143af69">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">CROSS</span> <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">CROSS</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8c3995" class="outline-5">
<h5 id="orgf8c3995">[fj] Full Join</h5>
<div class="outline-text-5" id="text-orgf8c3995">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">FULL</span> <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">FULL</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org2771f42" class="outline-5">
<h5 id="org2771f42">[foj] Full Outer Join</h5>
<div class="outline-text-5" id="text-org2771f42">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">FULL</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> fr...
# <span class="org-comment">--</span>
<span class="org-keyword">FULL</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd339e5a" class="outline-5">
<h5 id="orgd339e5a">[ij] Inner Join</h5>
<div class="outline-text-5" id="text-orgd339e5a">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org3094af3" class="outline-5">
<h5 id="org3094af3">[j] Join</h5>
<div class="outline-text-5" id="text-org3094af3">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org4c17bbd" class="outline-5">
<h5 id="org4c17bbd">[lj] Left Join</h5>
<div class="outline-text-5" id="text-org4c17bbd">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org292ec8e" class="outline-5">
<h5 id="org292ec8e">[loj] Left Outer Join</h5>
<div class="outline-text-5" id="text-org292ec8e">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">LEFT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> fr...
# <span class="org-comment">--</span>
<span class="org-keyword">LEFT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0032b0" class="outline-5">
<h5 id="orgc0032b0">[rj] Right Join</h5>
<div class="outline-text-5" id="text-orgc0032b0">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">RIGHT</span> <span class="org-keyword">JOIN</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">RIGHT</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9f592e" class="outline-5">
<h5 id="orgd9f592e">[roj] Right Outer Join</h5>
<div class="outline-text-5" id="text-orgd9f592e">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">RIGHT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> f...
# <span class="org-comment">--</span>
<span class="org-keyword">RIGHT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> $0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7efe560" class="outline-4">
<h4 id="org7efe560">Login</h4>
<div class="outline-text-4" id="text-org7efe560">
</div>
<div id="outline-container-org2e519f6" class="outline-5">
<h5 id="org2e519f6">[cl] Create SQL Authentication Login</h5>
<div class="outline-text-5" id="text-org2e519f6">
<p>
Creates a SQL Server Authentication login.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">CREATE</span> <span class="org-keyword">SQL</span> Server l...
# <span class="org-comment">--</span>
<span class="org-keyword">CREATE</span> LOGIN ${1:SQL_login_name}
<span class="org-keyword">WITH</span> PASSWORD = N<span class="org-string">'${2:Strong_P@ssword}'</span>$0 <span class="org-comment-delimiter">/* </span><span class="org-comment">HASHED */</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">MUST_CHANGE */</span>
<span class="org-comment">--  DEFAULT_DATABASE = database</span>
<span class="org-comment">--  DEFAULT_LANGUAGE = language</span>
<span class="org-comment">--  CHECK_POLICY = ON | OFF</span>
<span class="org-comment">--  SID = sid</span>
<span class="org-comment">--  CHECK_EXPIRATION = ON | OFF</span>
<span class="org-comment">--  CREDENTIAL = credential_name</span>
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org01d1487" class="outline-5">
<h5 id="org01d1487">Create Windows Authentication Login</h5>
<div class="outline-text-5" id="text-org01d1487">
<p>
Creates a Windows Authentication login.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">CREATE</span> Windows l...
# <span class="org-comment">--</span>
<span class="org-keyword">CREATE</span> LOGIN ${1:[domain_name\<span class="org-builtin">user_name</span>]}
<span class="org-keyword">FROM</span> WINDOWS$0
<span class="org-keyword">WITH</span>
DEFAULT_DATABASE = ${2:default_database}
<span class="org-comment">--  DEFAULT_LANGUAGE = language</span>
<span class="org-comment">--  CERTIFICATE certificate_name</span>
<span class="org-comment">--  ASYMMETRIC KEY key_name</span>
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga200094" class="outline-5">
<h5 id="orga200094">[dl] Drop Login</h5>
<div class="outline-text-5" id="text-orga200094">
<p>
Drop login.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> login
# <span class="org-comment">--</span>
<span class="org-keyword">DROP</span> LOGIN ${1:SQL_login_name}
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3532144" class="outline-4">
<h4 id="org3532144">Role</h4>
<div class="outline-text-4" id="text-org3532144">
</div>
<div id="outline-container-orga6745af" class="outline-5">
<h5 id="orga6745af">Create Role</h5>
<div class="outline-text-5" id="text-orga6745af">
<p>
Create Database Role.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-doc">USE ${1:database_name}</span>
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">ROLE</span> ${2:role_name}$0
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7012188" class="outline-4">
<h4 id="org7012188">Schema</h4>
<div class="outline-text-4" id="text-org7012188">
</div>
<div id="outline-container-org7bf817a" class="outline-5">
<h5 id="org7bf817a">Create Schema</h5>
<div class="outline-text-5" id="text-org7bf817a">
<p>
Create a database schema.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">SCHEMA</span> ${1:<span class="org-keyword">schema</span>}$0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf0ddabb" class="outline-4">
<h4 id="orgf0ddabb">Set options</h4>
<div class="outline-text-4" id="text-orgf0ddabb">
</div>
<div id="outline-container-orgfbb77af" class="outline-5">
<h5 id="orgfbb77af">[san] Set ANSI_NULLS</h5>
<div class="outline-text-5" id="text-orgfbb77af">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Change the <span class="org-keyword">current</span> A...
# <span class="org-comment">--</span>
<span class="org-doc">SET ANSI_NULLS ON$0</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7d05786" class="outline-5">
<h5 id="org7d05786">[sqi] Set QUOTED_IDENTIFIER</h5>
<div class="outline-text-5" id="text-org7d05786">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Change the <span class="org-keyword">current</span> ...
# <span class="org-comment">--</span>
<span class="org-doc">SET QUOTED_IDENTIFIER ON$0</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde2f762" class="outline-5">
<h5 id="orgde2f762">[sxa] Set XACT_ABORT</h5>
<div class="outline-text-5" id="text-orgde2f762">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Change the <span class="org-keyword">current</span> X...
# <span class="org-comment">--</span>
<span class="org-doc">SET XACT_ABORT OFF$0</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org90686b0" class="outline-4">
<h4 id="org90686b0">Stored Procedure</h4>
<div class="outline-text-4" id="text-org90686b0">
<p>
Naming convention: stored procedures are prefixed with <code>usp</code>.
</p>
</div>

<div id="outline-container-org5b0b1ae" class="outline-5">
<h5 id="org5b0b1ae">[cp] Create Procedure Basic Template</h5>
<div class="outline-text-5" id="text-org5b0b1ae">
<p>
Create a simple stored procedure with output parameter.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> stored proced...
# <span class="org-comment">--</span>
<span class="org-comment">-- Drop stored procedure if it already exists</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (<span class="org-string">'${1:[schema].[procedure_name]}'</span>, <span class="org-string">'P'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">PROCEDURE</span> $1;
<span class="org-doc">go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-doc">SET ANSI_NULLS ON</span>
<span class="org-doc">go</span>
<span class="org-doc">SET QUOTED_IDENTIFIER ON</span>
<span class="org-doc">go</span>
<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Author:      /* Author */</span>
<span class="org-comment">-- Create date: /* Create Date */</span>
<span class="org-comment">-- Description: /* Description */</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">PROCEDURE</span> $1
    <span class="org-comment">-- Add the parameters for the function here</span>
    <span class="org-variable-name">@</span>${2:parameter_name_1} ${3:parameter_data_type_1} = ${4:default_value_for_parameter_1}
    <span class="org-variable-name">@</span>${5:parameter_name_2} ${6:parameter_data_type_2} <span class="org-keyword">OUTPUT</span>
<span class="org-comment">-- WITH ENCRYPTION, RECOMPILE, EXECUTE AS CALLER|SELF|OWNER| 'user_name'</span>
<span class="org-keyword">AS</span>
<span class="org-keyword">BEGIN</span>
    <span class="org-comment">-- SET NOCOUNT ON added to prevent extra result sets from</span>
    <span class="org-comment">-- interfering with SELECT statements.</span>
    <span class="org-keyword">SET</span> NOCOUNT <span class="org-keyword">ON</span>;

    <span class="org-comment">-- Insert statements for procedure here</span>
    <span class="org-keyword">SELECT</span> <span class="org-variable-name">@</span>$2$0
<span class="org-keyword">END</span>
<span class="org-doc">go</span>

<span class="org-comment">--SET QUOTED_IDENTIFIER ON|OFF</span>
<span class="org-comment">--SET ANSI_NULLS ON|OFF</span>
<span class="org-comment">--go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Example to execute the stored procedure</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@</span>${7:variable_for_output_parameter} $6

<span class="org-keyword">EXECUTE</span> $1 <span class="org-comment-delimiter">/* </span><span class="org-comment">value_for_parameter_1 */</span>, $7 <span class="org-keyword">OUTPUT</span>

<span class="org-keyword">SELECT</span> $7
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0bca8a4" class="outline-5">
<h5 id="org0bca8a4">[crlp] Create CLR Procedure</h5>
<div class="outline-text-5" id="text-org0bca8a4">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> CLR stored pr...
# <span class="org-comment">--</span>
<span class="org-comment">--SET QUOTED_IDENTIFIER ON|OFF</span>
<span class="org-comment">--SET ANSI_NULLS ON|OFF</span>
<span class="org-comment">--go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">PROCEDURE</span> ${1:[<span class="org-keyword">schema</span>].[procedure_name]}
(
    <span class="org-variable-name">@</span>${2:<span class="org-keyword">parameter_name</span>} ${3:parameter_data_type}
)
<span class="org-comment">-- WITH EXECUTE AS CALLER|SELF|OWNER| 'user_name'</span>
<span class="org-keyword">AS</span> <span class="org-keyword">EXTERNAL</span> <span class="org-keyword">NAME</span> ${4:[assembly].[<span class="org-keyword">class</span>].[<span class="org-keyword">method</span>]};
<span class="org-doc">go</span>

<span class="org-comment">--SET QUOTED_IDENTIFIER ON|OFF</span>
<span class="org-comment">--SET ANSI_NULLS ON|OFF</span>
<span class="org-comment">--go$0</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb01d989" class="outline-5">
<h5 id="orgb01d989">[ap] Alter Procedure</h5>
<div class="outline-text-5" id="text-orgb01d989">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">ALTER</span> <span class="org-keyword">PROCEDURE</span>
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">PROCEDURE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org321d819" class="outline-5">
<h5 id="org321d819">[dp] Drop Procedure</h5>
<div class="outline-text-5" id="text-org321d819">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> stored <span class="org-keyword">procedure</span>
# <span class="org-comment">--</span>
<span class="org-keyword">DROP</span> <span class="org-keyword">PROCEDURE</span> $0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8074d91" class="outline-4">
<h4 id="org8074d91">Synonym</h4>
<div class="outline-text-4" id="text-org8074d91">
</div>
<div id="outline-container-orgf5d0b49" class="outline-5">
<h5 id="orgf5d0b49">Create Synonym</h5>
<div class="outline-text-5" id="text-orgf5d0b49">
<p>
Creates a synonym.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> SYNONYM ${1:[<span class="org-keyword">schema</span>].[synonym_name]}
<span class="org-keyword">FOR</span> ${2:[<span class="org-keyword">schema</span>].[<span class="org-builtin">object_name</span>]};
<span class="org-doc">go$0</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5b0138f" class="outline-4">
<h4 id="org5b0138f">Table</h4>
<div class="outline-text-4" id="text-org5b0138f">
</div>
<div id="outline-container-org0a61822" class="outline-5">
<h5 id="org0a61822">[ct] Create Table (crt)</h5>
<div class="outline-text-5" id="text-org0a61822">
<p>
Creates a table (and drop previous one with the same name).
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">table</span>
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (<span class="org-string">'${1:[schema].[table_name]}'</span>, <span class="org-string">'U'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">TABLE</span> $1;
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> $1
(
    ${2:column_1} ${3:data_type_1} ${4:column_nullability_1},
    ${5:column_2} ${6:data_type_2} ${5:column_nullability_2},$0
    <span class="org-keyword">CONSTRAINT</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">contraint_name */</span> <span class="org-keyword">PRIMARY</span> <span class="org-keyword">KEY</span> (<span class="org-comment-delimiter">/* </span><span class="org-comment">columns_in_primary_key */</span>)
);
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org13d15e0" class="outline-5">
<h5 id="org13d15e0">[ctt] Create Temporary Table (crtt)</h5>
<div class="outline-text-5" id="text-org13d15e0">
<p>
Creates a temporary table.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">temp</span> <span class="org-keyword">table</span>
# <span class="org-comment">--</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> #<span class="org-keyword">temp</span>
(
    $0
);
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd83a9f6" class="outline-5">
<h5 id="orgd83a9f6">[ctv] Create Table Variable (crtv)</h5>
<div class="outline-text-5" id="text-orgd83a9f6">
<p>
Creates a table variable.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">table</span> <span class="org-builtin">var</span>
# <span class="org-comment">--</span>
<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@tbl</span> <span class="org-keyword">TABLE</span>
(
    $0
)
</pre>
</div>
</div>
</div>

<div id="outline-container-org38c7578" class="outline-5">
<h5 id="org38c7578">[at] Alter Table fragment</h5>
<div class="outline-text-5" id="text-org38c7578">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> fragm...
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c52216" class="outline-5">
<h5 id="org3c52216">[ata] Add Column</h5>
<div class="outline-text-5" id="text-org3c52216">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Add</span> <span class="org-keyword">column</span>
# <span class="org-comment">--</span>
<span class="org-comment">-- Add a new column to the table.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
    <span class="org-keyword">ADD</span> [${2:new_column_name}] ${3:data_type} ${4:new_column_nullability};
<span class="org-doc">go$0</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b1b435" class="outline-5">
<h5 id="org3b1b435">[atac] Modify Column</h5>
<div class="outline-text-5" id="text-org3b1b435">
<div class="warning">
<p>
Running <code>ALTER COLUMN</code> without mentioning attribute <code>NOT NULL</code> will result in the
column being changed to <b>nullable</b>, if it is already not.
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Modify</span> <span class="org-keyword">column</span>
# <span class="org-comment">--</span>
<span class="org-comment">-- WARNING: If the column is not nullable, specify attribute NOT NULL.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
    <span class="org-keyword">ALTER</span> <span class="org-keyword">COLUMN</span> $0;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4932fd7" class="outline-5">
<h5 id="org4932fd7">[atd] Drop column</h5>
<div class="outline-text-5" id="text-org4932fd7">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">column</span>
# <span class="org-comment">--</span>
<span class="org-comment">-- Drop a column from the table.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
    <span class="org-keyword">DROP</span> <span class="org-keyword">COLUMN</span> $0;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga24f98a" class="outline-5">
<h5 id="orga24f98a">[crc] Add Constraint</h5>
<div class="outline-text-5" id="text-orga24f98a">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Add</span> <span class="org-keyword">constraint</span>
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
    <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> ${2:<span class="org-keyword">constraint_name</span>};
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org81e027e" class="outline-5">
<h5 id="org81e027e">[atdc] Drop Constraint</h5>
<div class="outline-text-5" id="text-org81e027e">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">constraint</span>
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
    <span class="org-keyword">DROP</span> <span class="org-keyword">CONSTRAINT</span> ${2:<span class="org-keyword">constraint_name</span>};
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org38db7db" class="outline-5">
<h5 id="org38db7db">[dt] Drop Table</h5>
<div class="outline-text-5" id="text-org38db7db">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">table</span>
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> *
             <span class="org-keyword">FROM</span> sys.tables
             <span class="org-keyword">JOIN</span> sys.schemas
               <span class="org-keyword">ON</span> sys.tables.schema_id = sys.schemas.schema_id
            <span class="org-keyword">WHERE</span> sys.schemas.<span class="org-keyword">name</span> = N<span class="org-string">'${1:schema}'</span>
              <span class="org-keyword">AND</span> sys.tables.<span class="org-keyword">name</span> = N<span class="org-string">'${2:table}'</span>)
    <span class="org-keyword">DROP</span> <span class="org-keyword">TABLE</span> $1.$2
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org95e2684" class="outline-4">
<h4 id="org95e2684">Transaction</h4>
<div class="outline-text-4" id="text-org95e2684">
</div>
<div id="outline-container-orgf2af63d" class="outline-5">
<h5 id="orgf2af63d">[bt] Begin Transaction</h5>
<div class="outline-text-5" id="text-orgf2af63d">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Begin</span> <span class="org-keyword">transaction</span>
# <span class="org-comment">--</span>
<span class="org-keyword">BEGIN</span> <span class="org-keyword">TRANSACTION</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-org0aebf64" class="outline-5">
<h5 id="org0aebf64">[ctr] Commit Transaction</h5>
<div class="outline-text-5" id="text-org0aebf64">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Commit</span> <span class="org-keyword">transaction</span>
# <span class="org-comment">--</span>
<span class="org-keyword">COMMIT</span> <span class="org-keyword">TRANSACTION</span> $0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf689071" class="outline-5">
<h5 id="orgf689071">[rt] Rollback Transaction</h5>
<div class="outline-text-5" id="text-orgf689071">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Rollback</span> <span class="org-keyword">transaction</span>
# <span class="org-comment">--</span>
<span class="org-keyword">ROLLBACK</span> <span class="org-keyword">TRANSACTION</span> $0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2ceacc0" class="outline-4">
<h4 id="org2ceacc0">Trigger</h4>
<div class="outline-text-4" id="text-org2ceacc0">
</div>
<div id="outline-container-org785be31" class="outline-5">
<h5 id="org785be31">Create Trigger</h5>
<div class="outline-text-5" id="text-org785be31">
<p>
Creates a trigger.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">trigger</span>
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (<span class="org-string">'${1:trigger_name}'</span>, <span class="org-string">'TR'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">TRIGGER</span> $1;
<span class="org-doc">go</span>

<span class="org-comment">-- =============================================</span>
<span class="org-doc">SET ANSI_NULLS ON</span>
<span class="org-doc">go</span>
<span class="org-doc">SET QUOTED_IDENTIFIER ON</span>
<span class="org-doc">go</span>
<span class="org-comment">-- =============================================</span>
<span class="org-comment">-- Author:      /* Author */</span>
<span class="org-comment">-- Create date: /* Create Date */</span>
<span class="org-comment">-- Description: /* Description */</span>
<span class="org-comment">-- =============================================</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">TRIGGER</span> $1
<span class="org-keyword">ON</span> ${2:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}
<span class="org-keyword">FOR</span> <span class="org-keyword">INSERT</span>, <span class="org-keyword">UPDATE</span>, <span class="org-keyword">DELETE</span>
<span class="org-keyword">AS</span>
<span class="org-keyword">BEGIN</span>
    <span class="org-comment">-- SET NOCOUNT ON added to prevent extra result sets from</span>
    <span class="org-comment">-- interfering with SELECT statements.</span>
    <span class="org-keyword">SET</span> NOCOUNT <span class="org-keyword">ON</span>;

    <span class="org-comment">-- Insert statements for trigger here</span>
    <span class="org-keyword">RAISERROR</span> (50009, 16, 10)
    $0
<span class="org-keyword">END</span>;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org15be792" class="outline-5">
<h5 id="org15be792">Enable Trigger</h5>
<div class="outline-text-5" id="text-org15be792">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Enable <span class="org-keyword">trigger</span>
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]} ENABLE <span class="org-keyword">TRIGGER</span> $0;
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d11a87" class="outline-5">
<h5 id="org5d11a87">Enable All Triggers</h5>
<div class="outline-text-5" id="text-org5d11a87">
<p>
Enable all triggers on table.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Enable <span class="org-keyword">all</span> triggers <span class="org-keyword">on</span>...
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}$0 ENABLE <span class="org-keyword">TRIGGER</span> <span class="org-keyword">ALL</span>;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org30aebeb" class="outline-5">
<h5 id="org30aebeb">Disable Trigger</h5>
<div class="outline-text-5" id="text-org30aebeb">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Disable <span class="org-keyword">trigger</span>
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]} DISABLE <span class="org-keyword">TRIGGER</span> $0;
</pre>
</div>
</div>
</div>

<div id="outline-container-org55b89bd" class="outline-5">
<h5 id="org55b89bd">Disable All Triggers</h5>
<div class="outline-text-5" id="text-org55b89bd">
<p>
Disable all triggers on table.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Disable <span class="org-keyword">all</span> triggers <span class="org-keyword">on</span>...
# <span class="org-comment">--</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ${1:[<span class="org-keyword">schema</span>].[<span class="org-keyword">table_name</span>]}$0 DISABLE <span class="org-keyword">TRIGGER</span> <span class="org-keyword">ALL</span>;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0eab835" class="outline-4">
<h4 id="org0eab835">User</h4>
<div class="outline-text-4" id="text-org0eab835">
</div>
<div id="outline-container-orgb44f7cd" class="outline-5">
<h5 id="orgb44f7cd">[cu] Create User</h5>
<div class="outline-text-5" id="text-orgb44f7cd">
<p>
Creates a database user.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">database</span> <span class="org-keyword">user</span>
# <span class="org-comment">--</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">USER</span> ${1:UserName}$0
<span class="org-keyword">FOR</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">FROM */</span> LOGIN <span class="org-comment-delimiter">/* </span><span class="org-comment">login_name */</span>
<span class="org-comment">--  CERTIFICATE certificate_name</span>
<span class="org-comment">--  ASYMMETRIC KEY key_name</span>
<span class="org-comment">--  WITHOUT LOGIN</span>
<span class="org-comment">--  WITH DEFAULT_SCHEMA = schema_name</span>
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org38d9689" class="outline-5">
<h5 id="org38d9689">[du] Drop User</h5>
<div class="outline-text-5" id="text-org38d9689">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">user</span>
# <span class="org-comment">--</span>
<span class="org-keyword">DROP</span> <span class="org-keyword">USER</span> ${1:<span class="org-builtin">user_name</span>}
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge295673" class="outline-4">
<h4 id="orge295673">User Defined Data Type</h4>
<div class="outline-text-4" id="text-orge295673">
</div>
<div id="outline-container-org00b85c0" class="outline-5">
<h5 id="org00b85c0">Create User-Defined Data Type</h5>
<div class="outline-text-5" id="text-org00b85c0">
<p>
Creates a user-defined data type.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">TYPE</span> ${1:[<span class="org-keyword">schema</span>].[my_data_type]}
<span class="org-keyword">FROM</span> ${2:data_type} ${3:column_nullability}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org67e7e55" class="outline-4">
<h4 id="org67e7e55">User Defined Table Type</h4>
<div class="outline-text-4" id="text-org67e7e55">
</div>
<div id="outline-container-org7ec0354" class="outline-5">
<h5 id="org7ec0354">Create User-Defined Table Type</h5>
<div class="outline-text-5" id="text-org7ec0354">
<p>
Creates a user-defined table type.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">TYPE</span> ${1:[<span class="org-keyword">schema</span>].[my_table_type]} <span class="org-keyword">AS</span> <span class="org-keyword">TABLE</span>
(
    ${2:column_1} ${3:data_type_1},
    ${4:column_2} ${5:data_type_2}
);
<span class="org-doc">go$0</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org72cd046" class="outline-4">
<h4 id="org72cd046">User Defined Type</h4>
<div class="outline-text-4" id="text-org72cd046">
</div>
<div id="outline-container-org9cc1a84" class="outline-5">
<h5 id="org9cc1a84">Create User-Defined Type</h5>
<div class="outline-text-5" id="text-org9cc1a84">
<p>
Creates a CLR integration user-defined type.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">TYPE</span> ${1:Utf8String}
<span class="org-keyword">EXTERNAL</span> <span class="org-keyword">NAME</span> ${2:utf8string}.${3:[Microsoft.Samples.SqlServer.utf8string]};
<span class="org-doc">go$0</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9e08884" class="outline-4">
<h4 id="org9e08884">View</h4>
<div class="outline-text-4" id="text-org9e08884">
</div>
<div id="outline-container-org5aed686" class="outline-5">
<h5 id="org5aed686">[cv] Create View</h5>
<div class="outline-text-5" id="text-org5aed686">
<p>
Creates a view.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Create</span> <span class="org-keyword">view</span>
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> <span class="org-builtin">OBJECT_ID</span> (<span class="org-string">'${1:[schema].[view_name]}'</span>, <span class="org-string">'V'</span>) <span class="org-keyword">IS</span> <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">DROP</span> <span class="org-keyword">VIEW</span> $1;
<span class="org-doc">go</span>

<span class="org-keyword">CREATE</span> <span class="org-keyword">VIEW</span> $1
<span class="org-comment">--WITH ENCRYPTION, SCHEMABINDING, VIEW_METADATA</span>
<span class="org-keyword">AS</span>
    <span class="org-keyword">SELECT</span> *
    <span class="org-keyword">FROM</span> ${2:[<span class="org-keyword">schema</span>].[sample_table]}
    $0
<span class="org-comment">-- WITH CHECK OPTION</span>
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org976e5b6" class="outline-5">
<h5 id="org976e5b6">[dv] Drop View</h5>
<div class="outline-text-5" id="text-org976e5b6">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Drop</span> <span class="org-keyword">view</span>
# <span class="org-comment">--</span>
<span class="org-keyword">DROP</span> <span class="org-keyword">VIEW</span> $0
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgad9314d" class="outline-4">
<h4 id="orgad9314d">&#x2014; Miscellaneous ---</h4>
<div class="outline-text-4" id="text-orgad9314d">
</div>
<div id="outline-container-org08da856" class="outline-5">
<h5 id="org08da856">[e] Execute</h5>
<div class="outline-text-5" id="text-org08da856">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">EXECUTE</span> fragment
# <span class="org-comment">--</span>
<span class="org-keyword">EXECUTE</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org141efa0" class="outline-5">
<h5 id="org141efa0">[sph] sp_help</h5>
<div class="outline-text-5" id="text-org141efa0">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Execute</span> sp_help
# <span class="org-comment">--</span>
<span class="org-keyword">EXEC</span> sp_help$0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf02d27" class="outline-5">
<h5 id="orgaf02d27">[spt] sp_helptext</h5>
<div class="outline-text-5" id="text-orgaf02d27">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Execute</span> sp_helptext
# <span class="org-comment">--</span>
<span class="org-keyword">EXEC</span> sp_helptext$0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddd6b56" class="outline-5">
<h5 id="orgddd6b56">[xpfd] xp_fixeddrives</h5>
<div class="outline-text-5" id="text-orgddd6b56">
<p>
Retrieve free space on all fixed drives.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Retrieve <span class="org-keyword">free</span> <span class="org-builtin">space</span> o...
# <span class="org-comment">--</span>
<span class="org-keyword">EXEC</span> master..xp_fixeddrives
</pre>
</div>
</div>
</div>

<div id="outline-container-org0ee6552" class="outline-5">
<h5 id="org0ee6552">[w2] Who2</h5>
<div class="outline-text-5" id="text-org0ee6552">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-keyword">Execute</span> sp_who2$0
# <span class="org-comment">--</span>
<span class="org-keyword">EXEC</span> sp_who2$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fec735" class="outline-5">
<h5 id="org6fec735">[err] @@ERROR</h5>
<div class="outline-text-5" id="text-org6fec735">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: <span class="org-builtin">@@ERROR</span> <span class="org-keyword">function</span> ...
# <span class="org-comment">--</span>
<span class="org-builtin">@@ERROR</span>$0
</pre>
</div>
</div>
</div>

<div id="outline-container-org8c67239" class="outline-5">
<h5 id="org8c67239">[mro] Most Recent Objects</h5>
<div class="outline-text-5" id="text-org8c67239">
<p>
Retrieve 20 most recently created objects.
</p>

<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Retrieve 20 most rec...
# <span class="org-comment">--</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 20 [<span class="org-keyword">name</span>], <span class="org-keyword">type</span>, crdate
<span class="org-keyword">FROM</span> sysobjects
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> crdate <span class="org-keyword">DESC</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org307ad81" class="outline-5">
<h5 id="org307ad81">Comment</h5>
<div class="outline-text-5" id="text-org307ad81">
<p>
A comment block.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * $0</span>
<span class="org-comment"> */</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2d43011" class="outline-5">
<h5 id="org2d43011">Comment</h5>
<div class="outline-text-5" id="text-org2d43011">
<p>
A multiline comment block.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment-delimiter">/*******************************************</span>
<span class="org-comment"> * $0</span>
<span class="org-comment"> *******************************************/</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb5fafeb" class="outline-3">
<h3 id="orgb5fafeb">Surround With&#x2026;</h3>
<div class="outline-text-3" id="text-orgb5fafeb">
</div>
<div id="outline-container-org29135fd" class="outline-4">
<h4 id="org29135fd">[begin] Code Snippet for BEGIN&#x2026;END block</h4>
<div class="outline-text-4" id="text-org29135fd">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Surround <span class="org-keyword">with</span> <span class="org-keyword">BEGIN</span>...
# <span class="org-comment">--</span>
<span class="org-keyword">BEGIN</span>
`yas-selected-<span class="org-type">text</span>`
<span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org06728df" class="outline-4">
<h4 id="org06728df">[if] Code Snippet for IF construct</h4>
<div class="outline-text-4" id="text-org06728df">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Surround <span class="org-keyword">with</span> <span class="org-keyword">IF</span>...
# <span class="org-comment">--</span>
<span class="org-keyword">IF</span> (${1:Condition})
<span class="org-keyword">BEGIN</span>
`yas-selected-<span class="org-type">text</span>`
<span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0e8fa20" class="outline-4">
<h4 id="org0e8fa20">[while] Code Snippet for WHILE loop</h4>
<div class="outline-text-4" id="text-org0e8fa20">
<div class="org-src-container">
<pre class="src src-sql"># <span class="org-keyword">name</span>: Surround <span class="org-keyword">with</span> <span class="org-keyword">WHILE</span>...
# <span class="org-comment">--</span>
<span class="org-keyword">WHILE</span> (${1:Condition})
<span class="org-keyword">BEGIN</span>
`yas-selected-<span class="org-type">text</span>`
<span class="org-keyword">END</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org5d078e8" class="outline-2">
<h2 id="org5d078e8">General SQL</h2>
<div class="outline-text-2" id="text-org5d078e8">
<p>
<a href="https://www.red-gate.com/simple-talk/sql/t-sql-programming/ten-common-sql-programming-mistakes/">https://www.red-gate.com/simple-talk/sql/t-sql-programming/ten-common-sql-programming-mistakes/</a>
</p>

<p>
Some good reading:
</p>
<ul class="org-ul">
<li><a href="https://sqlblog.org/2009/10/11/bad-habits-to-kick-avoiding-the-schema-prefix">Always specify the schema</a></li>
<li><a href="https://sqlblog.org/2008/10/30/my-stored-procedure-best-practices-checklist">Stored Procedure Best Practices</a></li>
<li><a href="https://blogs.sentryone.com/aaronbertrand/bad-habits-revival/">Bad habits to avoid</a></li>
</ul>

<p>
XXX Check out <a href="https://dataedo.com/kb/query/sql-server">https://dataedo.com/kb/query/sql-server</a>!!! (+ version for Oracle !!!)
</p>

<ul class="org-ul">
<li><a href="http://codereview.stackexchange.com/">http://codereview.stackexchange.com/</a>!!!</li>

<li>SQL Fiddle: <a href="http://sqlfiddle.com/#!3/e7875/5">http://sqlfiddle.com/#!3/e7875/5</a>
(MS SQL Server, Oracle, etc.)</li>

<li><a href="http://sqlblog.com/blogs/aaron_bertrand/archive/2008/10/30/my-stored-procedure-best-practices-checklist.aspx">http://sqlblog.com/blogs/aaron_bertrand/archive/2008/10/30/my-stored-procedure-best-practices-checklist.aspx</a></li>

<li><a href="https://blogs.sentryone.com/aaronbertrand/backtobasics-ctes">Common Table Expressions (CTEs)</a></li>
</ul>
</div>

<div id="outline-container-org6718213" class="outline-3">
<h3 id="org6718213"><span class="todo TODO">TODO</span> Tips and Tricks to Make SQL Server Management Studio Awesome</h3>
<div class="outline-text-3" id="text-org6718213">
<ul class="org-ul">
<li><a href="http://blogs.lessthandot.com/index.php/datamgmt/dbprogramming/tips-and-tricks-to-make/">http://blogs.lessthandot.com/index.php/datamgmt/dbprogramming/tips-and-tricks-to-make/</a>
Shortcuts, defaults, etc.</li>
</ul>
</div>
</div>

<div id="outline-container-orgf1c1658" class="outline-3">
<h3 id="orgf1c1658">SQL Server - Trace SQL</h3>
<div class="outline-text-3" id="text-orgf1c1658">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">DROP</span> EVENT <span class="org-keyword">SESSION</span> [afm-<span class="org-keyword">session</span>-<span class="org-keyword">sql</span>] <span class="org-keyword">ON</span> SERVER;

<span class="org-keyword">CREATE</span> EVENT <span class="org-keyword">SESSION</span> [afm-<span class="org-keyword">session</span>-<span class="org-keyword">sql</span>] <span class="org-keyword">ON</span> SERVER
<span class="org-keyword">ADD</span> EVENT sqlserver.sp_statement_completed(<span class="org-keyword">SET</span> collect_statement=(1)
    <span class="org-keyword">ACTION</span>(sqlserver.sql_text,sqlserver.username)
    <span class="org-keyword">WHERE</span> ([sqlserver].[like_i_sql_unicode_string]([sqlserver].[username],N<span class="org-string">'%afm%'</span>))
       <span class="org-keyword">AND</span> ([sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N<span class="org-string">'SELECT%'</span>) <span class="org-keyword">OR</span>
            [sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N<span class="org-string">'DELETE%'</span>) <span class="org-keyword">OR</span>
              [sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N<span class="org-string">'UPDATE%'</span>)
             )
             ),
<span class="org-keyword">ADD</span> EVENT sqlserver.sql_statement_completed(<span class="org-keyword">SET</span> collect_statement=(1)
    <span class="org-keyword">ACTION</span>(sqlserver.sql_text,sqlserver.username)
    <span class="org-keyword">WHERE</span> ([sqlserver].[like_i_sql_unicode_string]([sqlserver].[username],N<span class="org-string">'%afm%'</span>))
       <span class="org-keyword">AND</span> ([sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N<span class="org-string">'SELECT%'</span>) <span class="org-keyword">OR</span>
            [sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N<span class="org-string">'DELETE%'</span>) <span class="org-keyword">OR</span>
              [sqlserver].[like_i_sql_unicode_string]([sqlserver].[sql_text],N<span class="org-string">'UPDATE%'</span>)
             )
             )
<span class="org-keyword">ADD</span> TARGET package0.event_file(<span class="org-keyword">SET</span> filename=N<span class="org-string">'c:\temp\afm-session-sql'</span>)
<span class="org-keyword">WITH</span> (MAX_MEMORY=2048 KB,EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,MAX_DISPATCH_LATENCY=3 SECONDS,MAX_EVENT_SIZE=0 KB,MEMORY_PARTITION_MODE=<span class="org-keyword">NONE</span>,TRACK_CAUSALITY=<span class="org-keyword">OFF</span>,STARTUP_STATE=<span class="org-keyword">OFF</span>)
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1b5e4eb" class="outline-3">
<h3 id="org1b5e4eb">SQL Dates</h3>
<div class="outline-text-3" id="text-org1b5e4eb">
<p>
<a href="https://www.sqldates.com/">https://www.sqldates.com/</a>
</p>
</div>
</div>

<div id="outline-container-org60d2091" class="outline-3">
<h3 id="org60d2091">Code formatting</h3>
<div class="outline-text-3" id="text-org60d2091">
<ul class="org-ul">
<li><p>
<a href="http://programmers.stackexchange.com/questions/160522/should-i-put-newlines-before-or-after-binary-operators">http://programmers.stackexchange.com/questions/160522/should-i-put-newlines-before-or-after-binary-operators</a>
</p>

<p>
The &ldquo;joining&rdquo; condition is very important and it tends to get overlooked at
the end of the previous line.
</p></li>

<li><p>
<a href="http://sqlformat.org/">Online SQL formatting service</a>
<a href="http://www.sql-format.com/">SQL Formatter for SQL Server</a>
</p>

<p>
The <a href="http://www.ssmsboost.com/">SSMSBoost</a> plugin allows, among others, to reformat SQL code.
</p>

<p>
In Oracle SQL Developer, use <code>C-F7</code> to format SQL.
<a href="http://www.thatjeffsmith.com/archive/2012/11/keyboard-shortcuts-in-oracle-sql-developer/">http://www.thatjeffsmith.com/archive/2012/11/keyboard-shortcuts-in-oracle-sql-developer/</a>
</p>

<p>
It also exists in SQL Management Studio (other key binding)!
</p>

<p>
<b>Read <a href="http://stackoverflow.com/questions/101079/sql-server-management-studio-tips-for-improving-the-tsql-coding-process">http://stackoverflow.com/questions/101079/sql-server-management-studio-tips-for-improving-the-tsql-coding-process</a>!</b>
</p></li>

<li>Arjan Kemeling is a big fan of <b>DBVisualizer Pro</b>. Works great on all databases,
allows SQL code formatting, import data from txt, Excel,&#x2026; straight into the
database (new or existing table), you can also create SQL queries by selecting
tables, fields in de query builder or start from an existing SQL query, it
draws interactive database schemas (based on FKs), it has very handy &ldquo;copy
selection as&rdquo; features, launch SQL query and modify resulting data which you
can either save immediately or export to SQL queries or files, &#x2026;. the list
goes on and on. The only thing it does not do is compare databases, tables or
data.</li>
</ul>
</div>
</div>

<div id="outline-container-org729d64d" class="outline-3">
<h3 id="org729d64d">Table name as variable</h3>
<div class="outline-text-3" id="text-org729d64d">
<p>
Table names and column names need to be static, if the query is static.  For
dynamic table or column names, you should generate the full SQL dynamically, and
use <code>EXEC sp_executesql</code> to execute it.
</p>

<p>
More details here: <a href="http://www.sommarskog.se/dynamic_sql.html">The curse and blessings of dynamic SQL</a>.
</p>
</div>
</div>

<div id="outline-container-orgb7e32e5" class="outline-3">
<h3 id="orgb7e32e5">SQL Loop</h3>
<div class="outline-text-3" id="text-orgb7e32e5">
</div>
<div id="outline-container-org079a3d8" class="outline-4">
<h4 id="org079a3d8">While loop with temporary table</h4>
<div class="outline-text-4" id="text-org079a3d8">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Create a new table using the schema of another.</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">TABLE_NAME</span>
<span class="org-keyword">INTO</span> #TablesToControl
<span class="org-keyword">FROM</span> INFORMATION_SCHEMA.TABLES
<span class="org-keyword">WHERE</span> TABLE_TYPE = <span class="org-string">'BASE TABLE'</span> <span class="org-comment">-- OR TABLE_TYPE = 'VIEW'</span>

<span class="org-keyword">DECLARE</span> <span class="org-variable-name">@TableName</span> <span class="org-type">varchar</span>(128)

<span class="org-keyword">WHILE</span> <span class="org-keyword">EXISTS</span> (<span class="org-keyword">SELECT</span> 1 <span class="org-keyword">FROM</span> #TablesToControl)
<span class="org-keyword">BEGIN</span>
    <span class="org-comment">-- SET NOCOUNT ON added to prevent extra result sets from interfering with</span>
    <span class="org-comment">-- SELECT statements.</span>
    <span class="org-keyword">SET</span> NOCOUNT <span class="org-keyword">ON</span>;

    <span class="org-keyword">SELECT</span> <span class="org-variable-name">@TableName</span> = (<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 1 <span class="org-keyword">TABLE_NAME</span>
                         <span class="org-keyword">FROM</span> #TablesToControl
                         <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> <span class="org-keyword">TABLE_NAME</span>)

    <span class="org-comment">-- Do something with your @TableName.</span>
    <span class="org-keyword">DECLARE</span> <span class="org-variable-name">@Sql</span> <span class="org-type">nvarchar</span>(4000);
    <span class="org-keyword">SELECT</span> <span class="org-variable-name">@Sql</span> = N<span class="org-string">' SELECT '''</span> + <span class="org-builtin">QUOTENAME</span>(<span class="org-variable-name">@TableName</span>) + <span class="org-string">''', COUNT(*) '</span> +
                   <span class="org-string">' FROM '</span> + <span class="org-builtin">QUOTENAME</span>(<span class="org-variable-name">@TableName</span>);
                                        <span class="org-comment">-- QUOTENAME is important for security.</span>
    <span class="org-keyword">SELECT</span> <span class="org-variable-name">@Sql</span> = N<span class="org-string">' IF EXISTS (SELECT 1 FROM '</span> + <span class="org-builtin">QUOTENAME</span>(<span class="org-variable-name">@TableName</span>) + <span class="org-string">') '</span> +
                   <span class="org-string">'     PRINT '''</span> + <span class="org-variable-name">@TableName</span> + <span class="org-string">''''</span>;
    <span class="org-keyword">EXEC</span> sp_executesql <span class="org-variable-name">@Sql</span>

    <span class="org-comment">-- Remove the table name from the temporary table.</span>
    <span class="org-keyword">DELETE</span> <span class="org-keyword">FROM</span> #TablesToControl
    <span class="org-keyword">WHERE</span> <span class="org-keyword">TABLE_NAME</span> = <span class="org-variable-name">@TableName</span>
<span class="org-keyword">END</span>

<span class="org-keyword">DROP</span> <span class="org-keyword">TABLE</span> #TablesToControl;
</pre>
</div>

<p>
Other info at
<a href="http://stackoverflow.com/questions/18513986/how-to-write-a-foreach-in-sql-server">http://stackoverflow.com/questions/18513986/how-to-write-a-foreach-in-sql-server</a>
</p>
</div>
</div>

<div id="outline-container-orgbdf2ad9" class="outline-4">
<h4 id="orgbdf2ad9">Cursor-like FETCH-NEXT logic</h4>
<div class="outline-text-4" id="text-orgbdf2ad9">
<p>
<a href="https://stackoverflow.com/questions/11852782/t-sql-loop-over-query-results">https://stackoverflow.com/questions/11852782/t-sql-loop-over-query-results</a>
</p>
</div>
</div>

<div id="outline-container-orgdcc641f" class="outline-4">
<h4 id="orgdcc641f">Cursor</h4>
<div class="outline-text-4" id="text-orgdcc641f">
<p>
Cursors are slower than while loops?
</p>
</div>
</div>
</div>

<div id="outline-container-org637a0ba" class="outline-3">
<h3 id="org637a0ba">SQL error on update: The UPDATE statement conflicted with the FOREIGN KEY constraint</h3>
<div class="outline-text-3" id="text-org637a0ba">
<p>
<a href="https://stackoverflow.com/questions/23856420/sql-error-on-update-the-update-statement-conflicted-with-the-foreign-key-const">https://stackoverflow.com/questions/23856420/sql-error-on-update-the-update-statement-conflicted-with-the-foreign-key-const</a>
</p>
</div>
</div>

<div id="outline-container-orgdea4c17" class="outline-3">
<h3 id="orgdea4c17">Debugging triggers</h3>
<div class="outline-text-3" id="text-orgdea4c17">
<p>
The login for the developer must be a <b>member of the sysadmin server role</b>.
</p>

<p>
SQL Debugging significantly exposes the SQL Server Process - this is why it
requires sysadmin permission. If you don&rsquo;t want your developers to be sysadmin,
then you probably don&rsquo;t want them to be debugging in this way.
</p>

<p>
This feature was really designed for developers working on their own
workstations, not for use on production servers or other scenarios where there
are reasons you wouldn&rsquo;t want your developers to be sysadmin on the sql server
being debugged.
</p>
</div>
</div>

<div id="outline-container-orgcd1ab7b" class="outline-3">
<h3 id="orgcd1ab7b">Conversion failed when converting date and/or time from character string while inserting datetime</h3>
<div class="outline-text-3" id="text-orgcd1ab7b">
<p>
Whenever possible one should avoid culture specific date/time literals. There
are some secure formats:
</p>

<p>
All examples for 2016-09-15 17:30:00
</p>

<p>
ODBC (my favorite, as it is handled as the real type immediately)
{ts&rsquo;2016-09-15 17:30:00&rsquo;} &#x2013;Time Stamp
{d&rsquo;2016-09-15&rsquo;} &#x2013;Date only
{t&rsquo;17:30:00&rsquo;} &#x2013;Time only
</p>

<p>
ISO8601 (the best for everywhere)
2016-09-15T17:30:00 &#x2013;be aware of the T in the middle!
</p>

<p>
Unseparated (tiny risk to get misinterpreted as number)
20160915 &#x2013;only for pure date
</p>

<p>
Invalid dates tend to show up with strange errors
There is no 31st of June or 30th of February&#x2026;
</p>

<p>
One more reason: Order of execution!
</p>

<p>
SQL-Server is well know to do things in an order of execution one might not have
expected. Here is a great article: Rusano.com:
&ldquo;t-sql-functions-do-no-imply-a-certain-order-of-execution&rdquo; and here is the
related question.
</p>
</div>
</div>

<div id="outline-container-orgac27f08" class="outline-3">
<h3 id="orgac27f08">Retrieve DB version information</h3>
<div class="outline-text-3" id="text-orgac27f08">
</div>
<div id="outline-container-org4634f1a" class="outline-4">
<h4 id="org4634f1a">SQL Server</h4>
<div class="outline-text-4" id="text-org4634f1a">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span> <span class="org-builtin">@@version</span>;
</pre>
</div>

<p>
@EPO: Microsoft SQL Server 2012 (SP1) - 11.0.3000.0 (X64) Oct 19 2012 13:38:57
(c) Microsoft Corporation Enterprise Edition (64-bit) on Windows NT 6.1 &lt;X64&gt;
(Build 7601: Service Pack 1) (Hypervisor)
</p>
</div>
</div>

<div id="outline-container-org32e1010" class="outline-4">
<h4 id="org32e1010">Oracle</h4>
<div class="outline-text-4" id="text-org32e1010">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span> *
<span class="org-keyword">FROM</span> v$version
<span class="org-keyword">WHERE</span> banner <span class="org-keyword">LIKE</span> <span class="org-string">'Oracle%'</span>;
</pre>
</div>

<p>
@CSPO: Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production.
</p>
</div>
</div>
</div>

<div id="outline-container-org1567d6b" class="outline-3">
<h3 id="org1567d6b">List all columns (sfss, afm-fields, for all the fields in the SQL Database Schema)</h3>
<div class="outline-text-3" id="text-org1567d6b">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    sys.objects.<span class="org-keyword">name</span>                    <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    sys.columns.<span class="org-keyword">name</span>                    <span class="org-keyword">AS</span> <span class="org-keyword">COLUMN_NAME</span>
<span class="org-keyword">FROM</span> sys.objects
<span class="org-keyword">LEFT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> sys.columns
    <span class="org-keyword">ON</span> sys.objects.<span class="org-builtin">object_id</span> = sys.columns.<span class="org-builtin">object_id</span>
<span class="org-keyword">WHERE</span> <span class="org-keyword">type</span> = <span class="org-string">'U'</span>
    <span class="org-comment">-- AND sys.objects.name LIKE 'int_%' -- Table name.</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> sys.objects.<span class="org-keyword">name</span>, sys.columns.<span class="org-keyword">name</span>;
</pre>
</div>

<div class="note">
<p>
In SQL Server, column aliases should use brackets as using single quotes is
deprecated (not to mention easily confused with string literals).
</p>

<p>
But the only portable notation is using double quotes&#x2026;
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-builtin">OBJECT_NAME</span>(c.<span class="org-builtin">object_id</span>)            <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    c.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> <span class="org-keyword">COLUMN_NAME</span>,
    <span class="org-keyword">CASE</span> i.is_primary_key
        <span class="org-keyword">WHEN</span> 1 <span class="org-keyword">THEN</span> <span class="org-string">'!'</span>
        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> PRIMARY_KEY_DESC,
    <span class="org-keyword">CASE</span> c.is_nullable
        <span class="org-keyword">WHEN</span> 0 <span class="org-keyword">THEN</span> <span class="org-string">'*'</span>
        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> REQUIRED_DESC,
    t.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> DATA_TYPE,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> t.<span class="org-keyword">name</span> <span class="org-keyword">IN</span> (<span class="org-string">'char'</span>, <span class="org-string">'varchar'</span>, <span class="org-string">'nvarchar'</span>, <span class="org-string">'decimal'</span>) <span class="org-keyword">THEN</span> c.max_length
        <span class="org-keyword">ELSE</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> <span class="org-keyword">SIZE</span>,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> c.default_object_id = 0 <span class="org-keyword">OR</span> OBJECT_DEFINITION(c.default_object_id) = <span class="org-string">'(NULL)'</span> <span class="org-keyword">THEN</span> <span class="org-string">''</span>
        <span class="org-keyword">ELSE</span> OBJECT_DEFINITION(c.default_object_id)
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> DEFAULT_DESC,
    <span class="org-keyword">CASE</span> c.is_identity
        <span class="org-keyword">WHEN</span> 1 <span class="org-keyword">THEN</span> <span class="org-string">'IDENTITY'</span>
        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> IS_IDENTITY_DESC
    <span class="org-comment">-- XXX Add referenced table.</span>
    <span class="org-comment">-- ,CASE</span>
    <span class="org-comment">--     WHEN fk.name IS NOT NULL THEN '=&gt; ' + OBJECT_NAME(fk.object_id) + '.' + fk.name</span>
    <span class="org-comment">--     ELSE ''</span>
    <span class="org-comment">-- END                                 AS Foreign_Key</span>
<span class="org-keyword">FROM</span> sys.columns                        c
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.objects                  o
    <span class="org-keyword">ON</span> (o.<span class="org-builtin">object_id</span> = c.<span class="org-builtin">object_id</span>
        <span class="org-keyword">AND</span> <span class="org-keyword">type</span> <span class="org-keyword">IN</span> (<span class="org-string">'U'</span>,<span class="org-string">'V'</span>))          <span class="org-comment">-- User Tables and Views. XXX Test it!</span>
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.types                    t
    <span class="org-keyword">ON</span> c.user_type_id = t.user_type_id
<span class="org-comment">-- Remove the duplicate results (because some tables have more than one index</span>
<span class="org-comment">-- with the same leading key column) by applying a filter in the JOIN to</span>
<span class="org-comment">-- sys.indexes to only return the primary keys).</span>
<span class="org-comment">-- https://stackoverflow.com/questions/21759295/get-list-of-all-columns-with-complete-details-identity-nullabel-primary-key-i</span>
<span class="org-keyword">LEFT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> (sys.index_columns      ic
                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.indexes  i
                    <span class="org-keyword">ON</span> ic.<span class="org-builtin">object_id</span> = i.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> ic.index_id = i.index_id
                    <span class="org-keyword">AND</span> i.is_primary_key = 1)
    <span class="org-keyword">ON</span> ic.<span class="org-builtin">object_id</span> = c.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> ic.column_id = c.column_id
<span class="org-comment">-- LEFT JOIN sys.foreign_key_columns    fkc</span>
<span class="org-comment">--     ON fkc.parent_object_id = c.object_id AND fkc.parent_column_id = c.column_id</span>
<span class="org-comment">-- LEFT JOIN sys.columns                fk</span>
<span class="org-comment">--     ON fk.object_id = fkc.referenced_object_id AND fk.column_id = fkc.referenced_column_id</span>
<span class="org-keyword">WHERE</span>
    <span class="org-builtin">OBJECT_NAME</span>(c.<span class="org-builtin">object_id</span>) <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>  <span class="org-comment">-- Table name.</span>
    <span class="org-keyword">AND</span> c.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>                <span class="org-comment">-- Column name.</span>
    <span class="org-comment">-- AND fk.name LIKE '%%'            -- Foreign column name.  (Limit to FK constraints only.)</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-builtin">OBJECT_NAME</span>(c.<span class="org-builtin">object_id</span>),
    c.<span class="org-keyword">name</span>;
</pre>
</div>

<div class="note">
<p>
Join to <b>user</b> <code>_type_id</code> in the <code>sys.types</code> table.  <code>user_type_id</code> is identical to
<code>system_type_id</code> for system types &#x2013; See
<a href="https://msdn.microsoft.com/en-gb/library/ms188021.aspx">https://msdn.microsoft.com/en-gb/library/ms188021.aspx</a>
</p>

</div>
</div>
</div>

<div id="outline-container-org986dce0" class="outline-3">
<h3 id="org986dce0">6 Useful SQL Server Data Dictionary Queries Every DBA Should Have</h3>
<div class="outline-text-3" id="text-org986dce0">
<p>
<a href="https://dataedo.com/blog/useful-sql-server-data-dictionary-queries-every-dba-should-have">https://dataedo.com/blog/useful-sql-server-data-dictionary-queries-every-dba-should-have</a>
</p>

<ol class="org-ol">
<li>List of tables with number of rows and comments</li>
<li>List of views with definition and comments</li>
<li>Table columns details</li>
<li>Foreign keys</li>
<li>Views columns</li>
<li>Tables by number of columns</li>
</ol>
</div>
</div>

<div id="outline-container-orgc175011" class="outline-3">
<h3 id="orgc175011">Over 40 queries to find SQL Server tables with or without a certain property</h3>
<div class="outline-text-3" id="text-orgc175011">
<p>
<a href="https://www.mssqltips.com/sqlservertip/3402/over-40-queries-to-find-sql-server-tables-with-or-without-a-certain-property/">https://www.mssqltips.com/sqlservertip/3402/over-40-queries-to-find-sql-server-tables-with-or-without-a-certain-property/</a>
</p>
</div>
</div>

<div id="outline-container-org8473be2" class="outline-3">
<h3 id="org8473be2">List all constraints</h3>
<div class="outline-text-3" id="text-org8473be2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">EXEC</span> sp_help <span class="org-string">'rm'</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Return 1 row for each CHECK, UNIQUE, PRIMARY KEY, FOREIGN KEY, and/or DEFAULT.</span>
<span class="org-keyword">SELECT</span>
    <span class="org-comment">-- SCHEMA_NAME(schema_id)           AS SCHEMA_NAME,</span>
    <span class="org-builtin">OBJECT_NAME</span>(parent_object_id)       <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    type_desc                           <span class="org-keyword">AS</span> CONSTRAINT_TYPE,
    <span class="org-builtin">OBJECT_NAME</span>(<span class="org-builtin">OBJECT_ID</span>)              <span class="org-keyword">AS</span> <span class="org-keyword">CONSTRAINT_NAME</span>
<span class="org-keyword">FROM</span> sys.objects
<span class="org-keyword">WHERE</span>
    <span class="org-builtin">OBJECT_NAME</span>(parent_object_id) <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> type_desc <span class="org-keyword">LIKE</span> <span class="org-string">'%CONSTRAINT'</span>    <span class="org-comment">-- Ignore SQL triggers.</span>
    <span class="org-keyword">AND</span> <span class="org-builtin">OBJECT_NAME</span>(<span class="org-builtin">OBJECT_ID</span>) <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-keyword">table_name</span>,
    constraint_type <span class="org-keyword">DESC</span>,
    <span class="org-keyword">constraint_name</span>;
</pre>
</div>

<p>
If you need even more constraint information, look inside the stored procedure
<code>sp_helpconstraint</code> to see how to get certain information.  To view the source
code using SQL Server Management Studio, get into the &ldquo;Object Explorer&rdquo;.
</p>
</div>
</div>

<div id="outline-container-orgf8a9065" class="outline-3">
<h3 id="orgf8a9065">List all PRIMARY KEY constraints</h3>
<div class="outline-text-3" id="text-orgf8a9065">
<div class="tip">
<p>
<code>EXEC sp_pkeys</code> will return a row for each column that participates in the primary
key for the table.  The columns you are likely most interested in are
<code>COLUMN_NAME</code> and <code>PK_NAME</code>.
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For SQL Server.</span>
<span class="org-comment">-- Correct results for em (email not in em_PK) or eq (see EPO).</span>
<span class="org-keyword">SELECT</span>
    KU.TABLE_CATALOG                    <span class="org-keyword">AS</span> TABLE_QUALIFIER,
    KU.TABLE_SCHEMA                     <span class="org-keyword">AS</span> TABLE_OWNER,
    KU.<span class="org-keyword">TABLE_NAME</span>,
    KU.<span class="org-keyword">COLUMN_NAME</span>,
    KU.ORDINAL_POSITION                 <span class="org-keyword">AS</span> KEY_SEQ,
    KU.<span class="org-keyword">CONSTRAINT_NAME</span>                  <span class="org-keyword">AS</span> PK_NAME
<span class="org-keyword">FROM</span> INFORMATION_SCHEMA.TABLE_CONSTRAINTS TC
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> INFORMATION_SCHEMA.KEY_COLUMN_USAGE KU
    <span class="org-keyword">ON</span> (CONSTRAINT_TYPE = <span class="org-string">'PRIMARY KEY'</span>
        <span class="org-keyword">AND</span> TC.<span class="org-keyword">CONSTRAINT_NAME</span> = KU.<span class="org-keyword">CONSTRAINT_NAME</span>)
<span class="org-keyword">WHERE</span>
    KU.TABLE_SCHEMA = <span class="org-string">'afm'</span>
    <span class="org-keyword">AND</span> KU.<span class="org-keyword">TABLE_NAME</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> KU.<span class="org-keyword">CONSTRAINT_NAME</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    KU.<span class="org-keyword">TABLE_NAME</span>,
    KU.ORDINAL_POSITION;
</pre>
</div>

<div class="note">
<p>
Avoid using <code>INFORMATION_SCHEMA</code> views.  Worth reading Aaron&rsquo;s post on
<a href="http://sqlblog.com/blogs/aaron_bertrand/archive/2011/11/03/the-case-against-information-schema-views.aspx">The case against INFORMATION_SCHEMA views</a>.
</p>

<p>
Though, at <a href="http://stackoverflow.com/questions/219434/query-to-list-all-stored-procedures">http://stackoverflow.com/questions/219434/query-to-list-all-stored-procedures</a>,
they say that the <b>best way</b> is to <b>use the INFORMATION_SCHEMA tables</b>!???
</p>

<p>
Using <code>INFORMATION_SCHEMA</code> (in contrast to the <code>sys.</code> views) is always a good idea
as it is the official standard and is implemented in a couple other database
systems.
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For Oracle.</span>
<span class="org-keyword">SELECT</span>
    all_cons_columns.owner              <span class="org-keyword">AS</span> <span class="org-keyword">schema_name</span>,
    all_cons_columns.<span class="org-keyword">table_name</span>,
    all_cons_columns.<span class="org-keyword">column_name</span>,
    all_cons_columns.<span class="org-keyword">position</span>,
    all_constraints.<span class="org-keyword">constraint_name</span>
<span class="org-keyword">FROM</span> all_constraints, all_cons_columns
<span class="org-keyword">WHERE</span>
    all_constraints.constraint_type = <span class="org-string">'P'</span>
    <span class="org-keyword">AND</span> all_constraints.owner = all_cons_columns.owner
    <span class="org-keyword">AND</span> all_constraints.<span class="org-keyword">constraint_name</span> = all_cons_columns.<span class="org-keyword">constraint_name</span>
    <span class="org-keyword">AND</span> all_constraints.status = <span class="org-string">'ENABLED'</span>
    <span class="org-keyword">AND</span> all_cons_columns.owner <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> all_cons_columns.<span class="org-keyword">table_name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> all_constraints.<span class="org-keyword">constraint_name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    all_cons_columns.owner,
    all_cons_columns.<span class="org-keyword">table_name</span>,
    all_cons_columns.<span class="org-keyword">position</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orga725a1d" class="outline-3">
<h3 id="orga725a1d">List all FOREIGN KEY constraints</h3>
<div class="outline-text-3" id="text-orga725a1d">
<div class="tip">
<p>
<code>EXEC sp_helpconstraint 'rm'</code> will list:
</p>
<ul class="org-ul">
<li>all <b>constraints</b> for the table,</li>
<li>including <b>foreign keys that reference</b> the table (see also <code>EXEC sp_fkeys</code>).</li>
</ul>

<p>
In the first recordset, there will only be a column called <code>Object Name</code> (kind of
useless, since that&rsquo;s what you passed in).
</p>

<p>
In the second resultset, there will be the following columns: <code>constraint_type</code>,
<code>constraint_name</code>, and <code>constraint_keys</code>.
</p>

</div>

<div class="tip">
<p>
Reversely, <code>EXEC sp_fkeys</code> retrieves a list of <b>foreign keys REFERENCING</b> a table.
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- This query finds the constraint rm_rm_std in EPO.  Other flavors don't.</span>
<span class="org-keyword">SELECT</span>
    <span class="org-keyword">SCHEMA_NAME</span>(fkt.schema_id)          <span class="org-keyword">AS</span> FK_TABLE_SCHEMA_NAME,
    fkt.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> FK_TABLE_NAME,  <span class="org-comment">-- Referencing table.</span>
    fkc.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> FK_COLUMN_NAME, <span class="org-comment">-- Referencing column.</span>
    fkc.max_length                      <span class="org-keyword">AS</span> FK_SIZE,
    fk.<span class="org-keyword">name</span>                             <span class="org-keyword">AS</span> FK_NAME,        <span class="org-comment">-- Foreign Key CONSTRAINT_NAME.</span>
    sfkc.constraint_column_id           <span class="org-keyword">AS</span> FK_PART,
    <span class="org-keyword">SCHEMA_NAME</span>(pkt.schema_id)          <span class="org-keyword">AS</span> PK_TABLE_SCHEMA_NAME,
    pkt.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> PK_TABLE_NAME,  <span class="org-comment">-- Referenced table.</span>
    pkc.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> PK_COLUMN_NAME, <span class="org-comment">-- Referenced column.</span>
    pkc.max_length                      <span class="org-keyword">AS</span> PK_SIZE,
    <span class="org-keyword">CASE</span> <span class="org-builtin">OBJECTPROPERTY</span>(fk.<span class="org-builtin">OBJECT_ID</span>, <span class="org-string">'CnstIsDeleteCascade'</span>)
        <span class="org-keyword">WHEN</span> 0                          <span class="org-keyword">THEN</span> <span class="org-string">'0 = No Action'</span>
        <span class="org-keyword">WHEN</span> 1                          <span class="org-keyword">THEN</span> <span class="org-string">'1 = Cascade'</span>   <span class="org-comment">-- True.</span>
        <span class="org-keyword">WHEN</span> 2                          <span class="org-keyword">THEN</span> <span class="org-string">'2 = Set Null'</span>
        <span class="org-keyword">WHEN</span> 3                          <span class="org-keyword">THEN</span> <span class="org-string">'3 = Set Default'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> delete_action,
    <span class="org-keyword">CASE</span> <span class="org-builtin">OBJECTPROPERTY</span>(fk.<span class="org-builtin">OBJECT_ID</span>, <span class="org-string">'CnstIsUpdateCascade'</span>)
        <span class="org-keyword">WHEN</span> 0                          <span class="org-keyword">THEN</span> <span class="org-string">'0 = No Action'</span>
        <span class="org-keyword">WHEN</span> 1                          <span class="org-keyword">THEN</span> <span class="org-string">'1 = Cascade'</span>   <span class="org-comment">-- True.</span>
        <span class="org-keyword">WHEN</span> 2                          <span class="org-keyword">THEN</span> <span class="org-string">'2 = Set Null'</span>
        <span class="org-keyword">WHEN</span> 3                          <span class="org-keyword">THEN</span> <span class="org-string">'3 = Set Default'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> update_action,
    <span class="org-keyword">CASE</span> is_disabled
        <span class="org-keyword">WHEN</span> 1                          <span class="org-keyword">THEN</span> <span class="org-string">'1 = Disabled'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">'Enabled'</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> status_enabled  <span class="org-comment">-- WITH NOCHECK.</span>
<span class="org-keyword">FROM</span> sys.foreign_keys                   fk
<span class="org-keyword">JOIN</span> sys.foreign_key_columns            sfkc
    <span class="org-keyword">ON</span> sfkc.constraint_object_id = fk.<span class="org-builtin">object_id</span>
<span class="org-keyword">JOIN</span> sys.tables                         fkt
    <span class="org-keyword">ON</span> fkt.<span class="org-builtin">object_id</span> = fk.parent_object_id
<span class="org-keyword">JOIN</span> sys.columns                        fkc
    <span class="org-keyword">ON</span> sfkc.parent_object_id = fkc.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> sfkc.parent_column_id = fkc.column_id
<span class="org-keyword">JOIN</span> sys.tables                         pkt
    <span class="org-keyword">ON</span> pkt.<span class="org-builtin">object_id</span> = fk.referenced_object_id
<span class="org-keyword">JOIN</span> sys.columns                        pkc
    <span class="org-keyword">ON</span> sfkc.referenced_object_id = pkc.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> sfkc.referenced_column_id = pkc.column_id
<span class="org-keyword">WHERE</span>
    fkt.<span class="org-keyword">name</span>     <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>              <span class="org-keyword">AND</span> fkc.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> fk.<span class="org-keyword">name</span>  <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> pkt.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>              <span class="org-keyword">AND</span> pkc.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-keyword">SCHEMA_NAME</span>(fkt.schema_id),
    fkt.<span class="org-keyword">name</span>,
    pkt.<span class="org-keyword">name</span>,
    fk.<span class="org-keyword">name</span>,
    sfkc.constraint_column_id;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For Oracle.</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">DISTINCT</span>
    <span class="org-keyword">table_name</span>,
    <span class="org-keyword">column_name</span>,
    <span class="org-keyword">constraint_name</span>,
    <span class="org-keyword">position</span>,
    r_table_name
<span class="org-keyword">FROM</span>
(
    <span class="org-keyword">SELECT</span>
        uc.<span class="org-keyword">table_name</span>,
        uc.<span class="org-keyword">constraint_name</span>,
        cols.<span class="org-keyword">column_name</span>,
        (
            <span class="org-keyword">SELECT</span> <span class="org-keyword">table_name</span>
            <span class="org-keyword">FROM</span> user_constraints
            <span class="org-keyword">WHERE</span> <span class="org-keyword">constraint_name</span> = uc.r_constraint_name
        )                               r_table_name,
        (
            <span class="org-keyword">SELECT</span> <span class="org-keyword">column_name</span>
            <span class="org-keyword">FROM</span> user_cons_columns
            <span class="org-keyword">WHERE</span> <span class="org-keyword">constraint_name</span> = uc.r_constraint_name
                  <span class="org-keyword">AND</span> <span class="org-keyword">position</span> = cols.<span class="org-keyword">position</span>
        )                               r_column_name,
        cols.<span class="org-keyword">position</span>,
        uc.constraint_type
    <span class="org-keyword">FROM</span> user_constraints               uc
    <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> user_cons_columns        cols
        <span class="org-keyword">ON</span> uc.<span class="org-keyword">constraint_name</span> = cols.<span class="org-keyword">constraint_name</span>
    <span class="org-keyword">WHERE</span> constraint_type &lt;&gt; <span class="org-string">'C'</span>
)
<span class="org-keyword">CONNECT</span> <span class="org-keyword">BY</span>
NOCYCLE
    <span class="org-keyword">PRIOR</span> <span class="org-keyword">table_name</span> = r_table_name
    <span class="org-keyword">AND</span> <span class="org-keyword">PRIOR</span> <span class="org-keyword">column_name</span> = r_column_name
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-keyword">table_name</span>,
    r_table_name,
    <span class="org-keyword">position</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- For Oracle.</span>
<span class="org-keyword">SELECT</span>
    owner,
    <span class="org-keyword">table_name</span>,
    <span class="org-keyword">constraint_name</span>,
    r_owner,
    r_constraint_name,
    status
<span class="org-keyword">FROM</span> all_constraints
<span class="org-keyword">WHERE</span> constraint_type = <span class="org-string">'R'</span>             <span class="org-comment">-- Referential integrity</span>
    <span class="org-keyword">AND</span> r_constraint_name <span class="org-keyword">IN</span>
    (
        <span class="org-keyword">SELECT</span> <span class="org-keyword">constraint_name</span>
        <span class="org-keyword">FROM</span> all_constraints
        <span class="org-keyword">WHERE</span> constraint_type <span class="org-keyword">IN</span> (<span class="org-string">'P'</span>, <span class="org-string">'U'</span>) <span class="org-comment">-- Primary key or Unique</span>
            <span class="org-keyword">AND</span> <span class="org-keyword">table_name</span> <span class="org-keyword">LIKE</span> <span class="org-builtin">UPPER</span>(<span class="org-string">'%'</span>)
    )
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-keyword">table_name</span>,
    <span class="org-keyword">constraint_name</span>;
</pre>
</div>
</div>

<div id="outline-container-orged09570" class="outline-4">
<h4 id="orged09570">The DELETE statement conflicted with the REFERENCE constraint</h4>
<div class="outline-text-4" id="text-orged09570">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">DELETE</span> <span class="org-keyword">FROM</span> reserve_request <span class="org-keyword">WHERE</span> <span class="org-builtin">datediff</span>(DD, meeting_date, <span class="org-string">'2018-09-06'</span>) &gt;= 380
<span class="org-comment">-- Query executed successfully.</span>

<span class="org-keyword">DELETE</span> <span class="org-keyword">FROM</span> reserve <span class="org-keyword">WHERE</span> <span class="org-builtin">datediff</span>(DD, date_start, <span class="org-string">'2018-09-06'</span>) &gt;= 380
<span class="org-comment">-- The DELETE statement conflicted with the REFERENCE constraint "res_req_res_id". The conflict occurred in database "EPO_20180129_CAFM_PRD", table "afm.reserve_request", column 'res_id'.</span>
</pre>
</div>

<p>
Find the record from <code>FK_TABLE_NAME</code> which has a reference in <code>PK_TABLE_NAME</code>:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-string">'reserve_request'</span>                   <span class="org-keyword">AS</span> FK_TABLE_NAME,
    FK_TABLE_NAME.res_id                <span class="org-keyword">AS</span> FK_COLUMN_NAME,
    FK_TABLE_NAME.meeting_date,
    <span class="org-string">'reserve'</span>                           <span class="org-keyword">AS</span> PK_TABLE_NAME,
    PK_TABLE_NAME.res_id                <span class="org-keyword">AS</span> PK_COLUMN_NAME,
    PK_TABLE_NAME.date_start
<span class="org-keyword">FROM</span> reserve_request                    FK_TABLE_NAME
<span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> reserve                       PK_TABLE_NAME
    <span class="org-keyword">ON</span> FK_TABLE_NAME.res_id = PK_TABLE_NAME.res_id
<span class="org-keyword">WHERE</span>
    <span class="org-comment">-- DATEDIFF(DD, FK_TABLE_NAME.meeting_date, '2018-09-06') &gt;= 380</span>
    <span class="org-comment">-- OR</span>
    <span class="org-builtin">DATEDIFF</span>(DD, PK_TABLE_NAME.date_start, <span class="org-string">'2018-09-06'</span>) &gt;= 380;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9b0ff7c" class="outline-3">
<h3 id="org9b0ff7c">Disable/enable all constraints in the database</h3>
<div class="outline-text-3" id="text-org9b0ff7c">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Disable all constraints for database.</span>
<span class="org-keyword">EXEC</span> sp_MSforeachtable "<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ? <span class="org-keyword">NOCHECK</span> <span class="org-keyword">CONSTRAINT</span> <span class="org-keyword">all</span>"
</pre>
</div>

<p>
To switch them back on, run: (the print is optional of course and it is just
listing the tables)
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Enable all constraints for database.</span>
<span class="org-keyword">EXEC</span> sp_MSforeachtable <span class="org-variable-name">@command1</span>="<span class="org-keyword">print</span> <span class="org-string">'?'</span>", <span class="org-variable-name">@command2</span>="<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> ? <span class="org-keyword">WITH</span> <span class="org-keyword">CHECK</span> <span class="org-keyword">CHECK</span> <span class="org-keyword">CONSTRAINT</span> <span class="org-keyword">all</span>"
</pre>
</div>

<p>
I find it useful when populating data from one database to another.  It is much
better approach than dropping constraints.  It comes handy when dropping all the
data in the database and repopulating it (say, in test environment).
</p>
</div>
</div>

<div id="outline-container-org59cf545" class="outline-3">
<h3 id="org59cf545">Disable/enable all constraints on a table</h3>
<div class="outline-text-3" id="text-org59cf545">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Disable all table constraints.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">MyTable</span> <span class="org-keyword">NOCHECK</span> <span class="org-keyword">CONSTRAINT</span> <span class="org-keyword">ALL</span>

<span class="org-comment">-- Enable all table constraints.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">MyTable</span> <span class="org-keyword">WITH</span> <span class="org-keyword">CHECK</span> <span class="org-keyword">CHECK</span> <span class="org-keyword">CONSTRAINT</span> <span class="org-keyword">ALL</span>

<span class="org-comment">-- Disable single constraint.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">MyTable</span> <span class="org-keyword">NOCHECK</span> <span class="org-keyword">CONSTRAINT</span> MyConstraint

<span class="org-comment">-- Enable single constraint.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">MyTable</span> <span class="org-keyword">WITH</span> <span class="org-keyword">CHECK</span> <span class="org-keyword">CHECK</span> <span class="org-keyword">CONSTRAINT</span> MyConstraint
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf93fdc0" class="outline-3">
<h3 id="orgf93fdc0">List all non-NULLABLE columns</h3>
<div class="outline-text-3" id="text-orgf93fdc0">
<div class="tip">
<p>
SQL will use the <b>default value</b> if you do <b>not declare</b> the <b>non-nullable column</b> in
the <code>INSERT</code> statement.
</p>

</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-builtin">OBJECT_NAME</span>(<span class="org-builtin">object_id</span>)              <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    <span class="org-keyword">name</span>                                <span class="org-keyword">AS</span> <span class="org-keyword">COLUMN_NAME</span>,
    <span class="org-keyword">CASE</span> is_nullable
        <span class="org-keyword">WHEN</span> 0 <span class="org-keyword">THEN</span> <span class="org-string">'0 = No'</span>
        <span class="org-keyword">WHEN</span> 1 <span class="org-keyword">THEN</span> <span class="org-string">'1 = Yes'</span>
        <span class="org-keyword">ELSE</span> <span class="org-keyword">NULL</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> IS_NULLABLE_DESC
    <span class="org-comment">-- XXX Add the default value</span>
<span class="org-keyword">FROM</span> sys.columns
<span class="org-keyword">WHERE</span>
    <span class="org-builtin">object_id</span> = <span class="org-builtin">OBJECT_ID</span>(<span class="org-string">'rmpct'</span>)
    <span class="org-keyword">AND</span> is_nullable = 0                 <span class="org-comment">-- NO.</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-builtin">OBJECT_NAME</span>(<span class="org-builtin">object_id</span>),
    <span class="org-keyword">name</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org4cecb19" class="outline-3">
<h3 id="org4cecb19">List all DEFAULT constraints (with default value)</h3>
<div class="outline-text-3" id="text-org4cecb19">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    t.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    c.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> <span class="org-keyword">COLUMN_NAME</span>,
    dc.<span class="org-keyword">name</span>                             <span class="org-keyword">AS</span> <span class="org-keyword">CONSTRAINT_NAME</span>,
    dc.definition
<span class="org-keyword">FROM</span> sys.tables                         t
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.default_constraints      dc
    <span class="org-keyword">ON</span> t.<span class="org-builtin">object_id</span> = dc.parent_object_id
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.columns                  c
    <span class="org-keyword">ON</span> dc.parent_object_id = c.<span class="org-builtin">object_id</span> <span class="org-keyword">AND</span> dc.parent_column_id = c.column_id
<span class="org-keyword">WHERE</span>
    t.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> c.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    t.<span class="org-keyword">name</span>,
    c.<span class="org-keyword">name</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb67a88c" class="outline-3">
<h3 id="orgb67a88c">List all IDENTITY columns</h3>
<div class="outline-text-3" id="text-orgb67a88c">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    o.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    c.<span class="org-keyword">name</span>                              <span class="org-keyword">AS</span> <span class="org-keyword">COLUMN_NAME</span>,
    c.is_identity                       <span class="org-keyword">AS</span> IS_IDENTITY
<span class="org-keyword">FROM</span> sys.objects                        o
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.columns                  c
    <span class="org-keyword">ON</span> o.<span class="org-builtin">object_id</span> = c.<span class="org-builtin">object_id</span>
<span class="org-keyword">WHERE</span>
    c.is_identity = 1
    <span class="org-keyword">AND</span> o.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> c.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'cascading_id'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> o.<span class="org-keyword">name</span>;
</pre>
</div>

<p>
<code>SET IDENTITY_INSERT &lt;table&gt;</code>
</p>

<dl class="org-dl">
<dt>ON</dt><dd><b>Permit the insertion of an EXPLICIT value for the identity column</b> of
a table.</dd>

<dt>OFF</dt><dd>Revert the granted permission.</dd>
</dl>

<p>
If there is an error when inserting (Cannot insert explicit value for identity
column in table when <code>IDENTITY_INSERT</code> is set to <code>OFF</code>), the solution is either:
</p>

<ul class="org-ul">
<li>insert without specifying the value for the identity column, and let SQL
Server do (= adviced), or</li>

<li><code>SET IDENTITY_INSERT</code> to <code>ON</code> for the table (= not adviced).</li>
</ul>

<div class="warning">
<p>
At any time, <b>only one table in a session</b> can have the <code>IDENTITY_INSERT</code> property
set to <code>ON</code>.
</p>

</div>
</div>

<div id="outline-container-org3a0ec10" class="outline-4">
<h4 id="org3a0ec10">How to remove Identity from a column in a table?</h4>
<div class="outline-text-4" id="text-org3a0ec10">
<p>
<a href="https://stackoverflow.com/questions/8230257/remove-identity-from-a-column-in-a-table">https://stackoverflow.com/questions/8230257/remove-identity-from-a-column-in-a-table</a>
</p>

<p>
If you want to do this <b>without adding and populating a new column, without
reordering the columns</b>, and <b>with almost no downtime</b> because no data is changing
on the table, let&rsquo;s do some magic with partitioning functionality (but since no
partitions are used you don&rsquo;t need Enterprise edition):
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Create new table with no IDENTITY.</span>
<span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> [afm].[hrmpct_2](
    [ac_id] [<span class="org-type">varchar</span>](32) <span class="org-keyword">NULL</span>,
    [activity_log_id] [<span class="org-type">int</span>] <span class="org-keyword">NULL</span>,
    [area_chargable] [<span class="org-type">numeric</span>](7, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [area_comn] [<span class="org-type">numeric</span>](7, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [area_comn_nocup] [<span class="org-type">numeric</span>](7, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [area_comn_ocup] [<span class="org-type">numeric</span>](7, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [area_comn_rm] [<span class="org-type">numeric</span>](7, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [area_comn_serv] [<span class="org-type">numeric</span>](7, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [area_rm] [<span class="org-type">numeric</span>](8, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [bl_id] [<span class="org-type">varchar</span>](8) <span class="org-keyword">NULL</span>,
    [cost] [<span class="org-type">numeric</span>](9, 2) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [date_created] [<span class="org-type">datetime</span>] <span class="org-keyword">NULL</span>,
    [date_deleted] [<span class="org-type">datetime</span>] <span class="org-keyword">NULL</span>,
    [date_end] [<span class="org-type">datetime</span>] <span class="org-keyword">NULL</span>,
    [date_start] [<span class="org-type">datetime</span>] <span class="org-keyword">NULL</span>,
    [day_part] [<span class="org-type">smallint</span>] <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [del_user_name] [<span class="org-type">varchar</span>](64) <span class="org-keyword">NULL</span>,
    [dp_id] [<span class="org-type">varchar</span>](60) <span class="org-keyword">NULL</span>,
    [dv_id] [<span class="org-type">varchar</span>](60) <span class="org-keyword">NULL</span>,
    [em_id] [<span class="org-type">varchar</span>](60) <span class="org-keyword">NULL</span>,
    [fl_id] [<span class="org-type">varchar</span>](4) <span class="org-keyword">NULL</span>,
    [from_bl_id] [<span class="org-type">varchar</span>](8) <span class="org-keyword">NULL</span>,
    [from_fl_id] [<span class="org-type">varchar</span>](4) <span class="org-keyword">NULL</span>,
    [from_rm_id] [<span class="org-type">varchar</span>](8) <span class="org-keyword">NULL</span>,
    [mo_id] [<span class="org-type">int</span>] <span class="org-keyword">NULL</span>,
    [org_id] [<span class="org-type">varchar</span>](60) <span class="org-keyword">NULL</span>,
    [parent_pct_id] [<span class="org-type">int</span>] <span class="org-keyword">NULL</span>,
    [pct_space] [<span class="org-type">numeric</span>](6, 2) <span class="org-keyword">NULL</span>,
    [pct_time] [<span class="org-type">numeric</span>](6, 2) <span class="org-keyword">NULL</span>,
    [primary_em] [<span class="org-type">smallint</span>] <span class="org-keyword">NULL</span>,
    [primary_rm] [<span class="org-type">smallint</span>] <span class="org-keyword">NULL</span>,
    [prorate] [<span class="org-type">varchar</span>](8) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [resources] [<span class="org-type">varchar</span>](5000) <span class="org-keyword">NULL</span>,
    [rm_cat] [<span class="org-type">varchar</span>](12) <span class="org-keyword">NULL</span>,
    [rm_id] [<span class="org-type">varchar</span>](8) <span class="org-keyword">NULL</span>,
    [rm_type] [<span class="org-type">varchar</span>](50) <span class="org-keyword">NULL</span>,
    [status] [<span class="org-type">smallint</span>] <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [<span class="org-builtin">user_name</span>] [<span class="org-type">varchar</span>](64) <span class="org-keyword">NULL</span>,
    [visitor_id] [<span class="org-type">int</span>] <span class="org-keyword">NULL</span>,
    [pct_id] [<span class="org-type">int</span>] <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
    [confirmed] [<span class="org-type">smallint</span>] <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span> <span class="org-keyword">DEFAULT</span> ((0)),
    <span class="org-keyword">CONSTRAINT</span> [hrmpct_PK_2] <span class="org-keyword">PRIMARY</span> <span class="org-keyword">KEY</span> <span class="org-keyword">CLUSTERED</span>
    (
        [pct_id] <span class="org-keyword">ASC</span>
    ) <span class="org-keyword">WITH</span> (PAD_INDEX = <span class="org-keyword">ON</span>, STATISTICS_NORECOMPUTE = <span class="org-keyword">OFF</span>, IGNORE_DUP_KEY = <span class="org-keyword">OFF</span>, ALLOW_ROW_LOCKS = <span class="org-keyword">ON</span>, ALLOW_PAGE_LOCKS = <span class="org-keyword">ON</span>, <span class="org-keyword">FILLFACTOR</span> = 85)
)
<span class="org-doc">go</span>

<span class="org-comment">-- Data before switch.</span>
<span class="org-keyword">SELECT</span> <span class="org-string">'hrmpct'</span>, pct_id, *
<span class="org-keyword">FROM</span> hrmpct
<span class="org-keyword">UNION</span> <span class="org-keyword">ALL</span>
<span class="org-keyword">SELECT</span> <span class="org-string">'hrmpct_2'</span>, pct_id, *
<span class="org-keyword">FROM</span> hrmpct_2;

<span class="org-comment">-- Switch.</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> SWITCH <span class="org-keyword">TO</span> hrmpct_2;

<span class="org-comment">-- Data after switch.</span>
<span class="org-keyword">SELECT</span> <span class="org-string">'hrmpct'</span>, pct_id, *
<span class="org-keyword">FROM</span> hrmpct
<span class="org-keyword">UNION</span> <span class="org-keyword">ALL</span>
<span class="org-keyword">SELECT</span> <span class="org-string">'hrmpct_2'</span>, pct_id, *
<span class="org-keyword">FROM</span> hrmpct_2;

<span class="org-comment">-- Clean up.</span>
<span class="org-keyword">DROP</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span>;

<span class="org-keyword">EXEC</span> sys.sp_rename <span class="org-string">'hrmpct_2.hrmpct_PK_2'</span>, <span class="org-string">'hrmpct_PK'</span>;
<span class="org-keyword">EXEC</span> sys.sp_rename <span class="org-string">'hrmpct_2'</span>, <span class="org-string">'hrmpct'</span>, <span class="org-string">'OBJECT'</span>;

<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_cha__4DD54A14] <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_chargable];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_com__4EC96E4D] <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_comn];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_com__4FBD9286] <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_comn_nocup];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_com__50B1B6BF] <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_comn_ocup];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_com__51A5DAF8] <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_comn_rm];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_com__5299FF31] <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_comn_serv];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__area_rm__538E236A]  <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [area_rm];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__cost__55766BDC]     <span class="org-keyword">DEFAULT</span> ((0.0))     <span class="org-keyword">FOR</span> [cost];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__date_cre__566A9015] <span class="org-keyword">DEFAULT</span> (<span class="org-builtin">getdate</span>()) <span class="org-keyword">FOR</span> [date_created];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__date_del__575EB44E] <span class="org-keyword">DEFAULT</span> (<span class="org-builtin">getdate</span>()) <span class="org-keyword">FOR</span> [date_deleted];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__day_part__5A3B20F9] <span class="org-keyword">DEFAULT</span> ((0))       <span class="org-keyword">FOR</span> [day_part];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__pct_spac__65ACD3A5] <span class="org-keyword">DEFAULT</span> ((100.00))  <span class="org-keyword">FOR</span> [pct_space];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__pct_time__66A0F7DE] <span class="org-keyword">DEFAULT</span> ((100.00))  <span class="org-keyword">FOR</span> [pct_time];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__prorate__697D6489]  <span class="org-keyword">DEFAULT</span> (<span class="org-string">'NONE'</span>)    <span class="org-keyword">FOR</span> [prorate];
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">hrmpct</span> <span class="org-keyword">ADD</span> <span class="org-keyword">CONSTRAINT</span> [DF__hrmpct__status__6E4219A6]   <span class="org-keyword">DEFAULT</span> ((1))       <span class="org-keyword">FOR</span> [status];

<span class="org-comment">-- Test.</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 10 pct_id, *
<span class="org-keyword">FROM</span> hrmpct;

<span class="org-keyword">UPDATE</span> hrmpct
<span class="org-keyword">SET</span> pct_id = pct_id + 1;

<span class="org-keyword">SELECT</span> <span class="org-keyword">TOP</span> 10 pct_id, *
<span class="org-keyword">FROM</span> hrmpct;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6822a4f" class="outline-3">
<h3 id="org6822a4f">List triggers</h3>
<div class="outline-text-3" id="text-org6822a4f">
<p>
<a href="https://stackoverflow.com/questions/4305691/need-to-list-all-triggers-in-sql-server-database-with-table-name-and-tables-sch">https://stackoverflow.com/questions/4305691/need-to-list-all-triggers-in-sql-server-database-with-table-name-and-tables-sch</a>
to <b>list database triggers</b> as well!
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-builtin">OBJECT_NAME</span>(so.parent_obj)          <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    so.<span class="org-keyword">name</span>                             <span class="org-keyword">AS</span> <span class="org-keyword">TRIGGER_NAME</span>,
    <span class="org-builtin">OBJECTPROPERTY</span>(so.id, <span class="org-string">'ExecIsInsertTrigger'</span>)    <span class="org-keyword">AS</span> "<span class="org-keyword">INSERT</span>",
    <span class="org-builtin">OBJECTPROPERTY</span>(so.id, <span class="org-string">'ExecIsUpdateTrigger'</span>)    <span class="org-keyword">AS</span> "<span class="org-keyword">UPDATE</span>",
    <span class="org-builtin">OBJECTPROPERTY</span>(so.id, <span class="org-string">'ExecIsDeleteTrigger'</span>)    <span class="org-keyword">AS</span> "<span class="org-keyword">DELETE</span>",
    <span class="org-builtin">OBJECTPROPERTY</span>(so.id, <span class="org-string">'ExecIsAfterTrigger'</span>)     <span class="org-keyword">AS</span> <span class="org-keyword">AFTER</span>,
    <span class="org-builtin">OBJECTPROPERTY</span>(so.id, <span class="org-string">'ExecIsInsteadOfTrigger'</span>) <span class="org-keyword">AS</span> INSTEAD_OF,
    <span class="org-builtin">OBJECTPROPERTY</span>(so.id, <span class="org-string">'ExecIsTriggerDisabled'</span>)  <span class="org-keyword">AS</span> DISABLED
<span class="org-keyword">FROM</span> sysobjects                         so
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sysobjects                   so2
    <span class="org-keyword">ON</span> so.parent_obj = so2.Id
<span class="org-keyword">WHERE</span>
    so.<span class="org-keyword">type</span> = <span class="org-string">'TR'</span>
    <span class="org-keyword">AND</span> <span class="org-builtin">OBJECT_NAME</span>(so.parent_obj) <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
    <span class="org-keyword">AND</span> so.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-builtin">OBJECT_NAME</span>(so.parent_obj),
    so.<span class="org-keyword">name</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-builtin">OBJECT_NAME</span>(parent_id)              <span class="org-keyword">AS</span> <span class="org-keyword">TABLE_NAME</span>,
    <span class="org-keyword">name</span>                                <span class="org-keyword">AS</span> <span class="org-keyword">TRIGGER_NAME</span>,
    is_instead_of_trigger               <span class="org-keyword">AS</span> INSTEAD_OF,
    is_disabled                         <span class="org-keyword">AS</span> DISABLED
<span class="org-keyword">FROM</span> sys.triggers
<span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%%'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-builtin">OBJECT_NAME</span>(parent_id),
    sys.triggers.<span class="org-keyword">name</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- List triggers.</span>
<span class="org-keyword">SELECT</span>
    tbl.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> "<span class="org-keyword">TABLE</span>",
    trg.<span class="org-keyword">name</span>                            <span class="org-keyword">AS</span> <span class="org-keyword">TRIGGER_NAME</span>,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> is_instead_of_trigger = 1  <span class="org-keyword">THEN</span> <span class="org-string">'Instead of'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">'After'</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> ACTIVATION,
   (<span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> <span class="org-builtin">OBJECTPROPERTY</span>(trg.<span class="org-builtin">object_id</span>, <span class="org-string">'ExecIsInsertTrigger'</span>) = 1
                                        <span class="org-keyword">THEN</span> <span class="org-string">'Insert '</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>
    +
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> <span class="org-builtin">OBJECTPROPERTY</span>(trg.<span class="org-builtin">object_id</span>, <span class="org-string">'ExecIsUpdateTrigger'</span>) = 1
                                        <span class="org-keyword">THEN</span> <span class="org-string">'Update '</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>
    +
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> <span class="org-builtin">OBJECTPROPERTY</span>(trg.<span class="org-builtin">object_id</span>, <span class="org-string">'ExecIsDeleteTrigger'</span>) = 1
                                        <span class="org-keyword">THEN</span> <span class="org-string">'Delete'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>)                                <span class="org-keyword">AS</span> EVENT,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> trg.parent_class = 1       <span class="org-keyword">THEN</span> <span class="org-string">'Table trigger'</span>
        <span class="org-keyword">WHEN</span> trg.parent_class = 0       <span class="org-keyword">THEN</span> <span class="org-string">'Database trigger'</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> <span class="org-keyword">CLASS</span>,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> trg.<span class="org-keyword">type</span> = <span class="org-string">'TA'</span>            <span class="org-keyword">THEN</span> <span class="org-string">'Assembly (CLR) trigger'</span>
        <span class="org-keyword">WHEN</span> trg.<span class="org-keyword">type</span> = <span class="org-string">'TR'</span>            <span class="org-keyword">THEN</span> <span class="org-string">'SQL trigger'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">''</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> <span class="org-keyword">TYPE</span>,
    <span class="org-keyword">CASE</span>
        <span class="org-keyword">WHEN</span> is_disabled = 1            <span class="org-keyword">THEN</span> <span class="org-string">'1 = Disabled'</span>
                                        <span class="org-keyword">ELSE</span> <span class="org-string">'0 = Enabled'</span>
    <span class="org-keyword">END</span>                                 <span class="org-keyword">AS</span> STATUS,
    OBJECT_DEFINITION(trg.<span class="org-builtin">object_id</span>)    <span class="org-keyword">AS</span> DEFINITION
<span class="org-keyword">FROM</span> sys.triggers                       trg
<span class="org-keyword">LEFT</span> <span class="org-keyword">JOIN</span> sys.objects                   tbl
    <span class="org-keyword">ON</span> trg.parent_id = tbl.<span class="org-builtin">object_id</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    tbl.<span class="org-keyword">name</span>,
    trg.<span class="org-keyword">name</span>;
</pre>
</div>

<div class="warning">
<p>
<b>Non-updating updates</b> (such as <code>UPDATE TableName SET field1 = field1</code>) do fire
<code>UPDATE</code> triggers on the table being updated, and indicate that the field was
updated (if you check using either the <code>UPDATE()</code> or <code>COLUMNS_UPDATED</code> functions).
</p>

<p>
The field in both <code>INSERTED</code> and <code>DELETED</code> tables are the same value.
</p>

</div>

<p>
How often do Update triggers fire on a multi-record update?
</p>

<p>
Microsoft SQL Server only supports <b>statement level</b> triggers: a statement level
trigger will <b>fire once for the whole statement</b>.
</p>
</div>

<div id="outline-container-org5bdc7c5" class="outline-4">
<h4 id="org5bdc7c5">Nested triggers (server option)</h4>
<div class="outline-text-4" id="text-org5bdc7c5">
<p>
Check whether nested triggers are turned on or off.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">EXEC</span> sp_configure <span class="org-string">'nested triggers'</span>;
</pre>
</div>

<ul class="org-ul">
<li>If the <code>run_value</code> is 0, then the nested triggers are off (<code>AFTER</code> triggers cannot
cascade).</li>

<li>If the value is 1 (the default), then they are on (<code>AFTER</code> triggers can cascade
to as many as 32 levels &#x2013; If any trigger in the chain sets off an infinite
loop, the nesting level is exceeded and the trigger is canceled with error
message).</li>
</ul>

<div class="note">
<p>
<code>INSTEAD OF</code> triggers (which perform their actions <i>instead of</i> the action that
fired them) can be nested regardless of the setting of this option.
</p>

</div>
</div>
</div>

<div id="outline-container-org7345c89" class="outline-4">
<h4 id="org7345c89">Recursive triggers (database option)</h4>
<div class="outline-text-4" id="text-org7345c89">
<p>
<b>Direct recursion</b> only.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">ALTER</span> <span class="org-keyword">DATABASE</span> MyDataBase <span class="org-keyword">SET</span> RECURSIVE_TRIGGERS <span class="org-keyword">ON</span>
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5744fc0" class="outline-4">
<h4 id="org5744fc0">For EPO cascading_update/delete triggers</h4>
<div class="outline-text-4" id="text-org5744fc0">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-string">'referenced_trigger'</span>                <span class="org-keyword">AS</span> trigger_type,
    t.<span class="org-keyword">name</span>
<span class="org-keyword">FROM</span> sys.triggers                       t
<span class="org-keyword">WHERE</span> t.<span class="org-keyword">name</span> <span class="org-keyword">LIKE</span> <span class="org-string">'%cascad%'</span>

<span class="org-keyword">UNION</span> <span class="org-keyword">ALL</span>

<span class="org-keyword">SELECT</span>
    <span class="org-string">'referencing_trigger'</span>               <span class="org-keyword">AS</span> trigger_type,
    t.<span class="org-keyword">name</span>
<span class="org-keyword">FROM</span> sys.triggers                       t
<span class="org-keyword">WHERE</span> <span class="org-keyword">EXISTS</span>
(
    <span class="org-keyword">SELECT</span> 1
    <span class="org-keyword">FROM</span> sys.columns                    c
    <span class="org-keyword">WHERE</span> <span class="org-builtin">OBJECT_NAME</span>(c.<span class="org-builtin">object_id</span>) + <span class="org-string">'_'</span> + c.<span class="org-keyword">name</span> + <span class="org-string">'_t'</span> = t.<span class="org-keyword">name</span>
)
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> 1, 2;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org66d8b41" class="outline-3">
<h3 id="org66d8b41">Using a DML trigger with a reminder e-mail message</h3>
<div class="outline-text-3" id="text-org66d8b41">
<p>
The following example sends an e-mail message to a specified person (MaryM) when
the Customer table changes.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">TRIGGER</span> <span class="org-function-name">reminder2</span>
<span class="org-keyword">ON</span> Sales.Customer
<span class="org-keyword">AFTER</span> <span class="org-keyword">INSERT</span>, <span class="org-keyword">UPDATE</span>, <span class="org-keyword">DELETE</span>
<span class="org-keyword">AS</span>
   <span class="org-keyword">EXEC</span> msdb.dbo.sp_send_dbmail
        <span class="org-variable-name">@profile_name</span> = <span class="org-string">'AdventureWorks2012 Administrator'</span>,
        <span class="org-variable-name">@recipients</span> = <span class="org-string">'danw@Adventure-Works.com'</span>,
        <span class="org-variable-name">@body</span> = <span class="org-string">'Don''t forget to print a report for the sales force.'</span>,
        <span class="org-variable-name">@subject</span> = <span class="org-string">'Reminder'</span>;
<span class="org-doc">go</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8bb223" class="outline-3">
<h3 id="orga8bb223">List all stored procedures and functions</h3>
<div class="outline-text-3" id="text-orga8bb223">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-keyword">name</span>,
    <span class="org-keyword">type</span>
<span class="org-keyword">FROM</span> dbo.sysobjects
<span class="org-keyword">WHERE</span> <span class="org-keyword">type</span> <span class="org-keyword">IN</span> (
    <span class="org-string">'P'</span>,                                <span class="org-comment">-- Stored Procedures.</span>
    <span class="org-string">'TF'</span>,                               <span class="org-comment">-- Table-valued Functions.</span>
    <span class="org-string">'FN'</span>,                               <span class="org-comment">-- Scalar-valued Functions.</span>
    <span class="org-string">'IF'</span>                                <span class="org-comment">-- Inline table-valued Functions.</span>
)
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-keyword">type</span>,
    <span class="org-keyword">name</span>;
<span class="org-comment">-- Should order by stored proc first, then by functions (like in object explorer).</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org11579d0" class="outline-3">
<h3 id="org11579d0">List all views, stored procedures, functions and triggers REFERENCING a particular table</h3>
<div class="outline-text-3" id="text-org11579d0">
<div class="tip">
<p>
<code>EXEC sp_depends</code> lists the database objects that depend on a table.  Though, this
stored procedure will be removed in future versions of Microsoft SQL Server.
</p>

</div>

<p>
A non-query way, using SQL Server Management Studio:
</p>
<ol class="org-ol">
<li>locate the table,</li>
<li>right-click and</li>
<li>choose &ldquo;<b>View dependencies</b>&rdquo;.</li>
</ol>

<div class="warning">
<p>
As commenters said, &ldquo;View Dependencies&rdquo; is not very reliable &#x2013; and actually
dangerous to use!
</p>

</div>

<p>
Also use <b>Red Gate SQL Search</b> or <b>ApexSQL Search</b> (FREE) (in SQL Server Management
Studio) for that&#x2026;
</p>

<p>
<b>View views</b>, <b>stored procedures</b>, <b>functions</b> (?) and <b>triggers</b> that <b>depend on</b>
a particular table.
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-keyword">SCHEMA_NAME</span>(o.SCHEMA_ID) + <span class="org-string">'.'</span> + o.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> <span class="org-keyword">NAME</span>,
    o.type_desc                         <span class="org-keyword">AS</span> <span class="org-keyword">TYPE</span>,
    referenced_schema_name              <span class="org-keyword">AS</span> REFERENCED_SCHEMA,
    referenced_entity_name              <span class="org-keyword">AS</span> REFERENCED_TABLE_NAME,
    o1.type_desc                        <span class="org-keyword">AS</span> REFERENCED_OBJECT_TYPE_DESC
    <span class="org-comment">--,sed.* -- Uncomment for all the columns.</span>
<span class="org-keyword">FROM</span> sys.sql_expression_dependencies    sed
<span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.objects                  o
    <span class="org-keyword">ON</span> sed.referencing_id = o.[<span class="org-builtin">object_id</span>]
<span class="org-keyword">LEFT</span> <span class="org-keyword">OUTER</span> <span class="org-keyword">JOIN</span> sys.objects             o1
    <span class="org-keyword">ON</span> sed.referenced_id = o1.[<span class="org-builtin">object_id</span>]
<span class="org-keyword">WHERE</span> referenced_entity_name = <span class="org-string">'kpi_actuals'</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> <span class="org-keyword">name</span>;
</pre>
</div>

<p>
(Less results than with <code>EXEC sp_depends</code>, for example for table <code>wr</code>!?)
</p>

<p>
Find text in views, stored procedures, functions, triggers, default constraints,
etc.:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-keyword">SCHEMA_NAME</span>(o.schema_id) + <span class="org-string">'.'</span> + o.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> <span class="org-keyword">NAME</span>,
    o.type_desc                         <span class="org-keyword">AS</span> <span class="org-keyword">TYPE</span>,
    OBJECT_DEFINITION(<span class="org-builtin">object_id</span>)        <span class="org-keyword">AS</span> <span class="org-keyword">SOURCE</span>
<span class="org-keyword">FROM</span> sys.objects                        o
<span class="org-keyword">WHERE</span>
    <span class="org-builtin">UPPER</span>(OBJECT_DEFINITION(o.<span class="org-builtin">object_id</span>)) <span class="org-keyword">LIKE</span> <span class="org-string">'%'</span> + <span class="org-builtin">UPPER</span>(<span class="org-string">'kpi_actuals'</span>) + <span class="org-string">'%'</span>
    <span class="org-keyword">AND</span> o.<span class="org-keyword">type</span> <span class="org-keyword">IN</span> (
        <span class="org-string">'C'</span>,                            <span class="org-comment">-- Check constraint.</span>
        <span class="org-string">'D'</span>,                            <span class="org-comment">-- Default (constraint or stand-alone).</span>
        <span class="org-string">'P'</span>,                            <span class="org-comment">-- SQL stored procedure.</span>
        <span class="org-string">'FN'</span>,                           <span class="org-comment">-- SQL scalar function.</span>
        <span class="org-string">'R'</span>,                            <span class="org-comment">-- Rule.</span>
        <span class="org-string">'RF'</span>,                           <span class="org-comment">-- Replication filter procedure.</span>
        <span class="org-string">'TR'</span>,                           <span class="org-comment">-- SQL trigger (schema-scoped DML trigger, or DDL trigger at either the database or server scope).</span>
        <span class="org-string">'IF'</span>,                           <span class="org-comment">-- SQL inline table-valued function.</span>
        <span class="org-string">'TF'</span>,                           <span class="org-comment">-- SQL table-valued function.</span>
        <span class="org-string">'V'</span>)                            <span class="org-comment">-- View.</span>
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> o.<span class="org-keyword">name</span>;
</pre>
</div>

<p>
(More results than with <code>EXEC sp_depends</code>, for example for table <code>wr</code>.)
</p>
</div>
</div>

<div id="outline-container-org1d42dc0" class="outline-3">
<h3 id="org1d42dc0">List all indexes and index columns</h3>
<div class="outline-text-3" id="text-org1d42dc0">
<p>
You can also use <code>EXEC sp_helpindex</code> to view all the indexes (and index columns)
of one table:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">EXEC</span> sys.sp_helpindex <span class="org-variable-name">@objname</span> = N<span class="org-string">'activity_log'</span>
</pre>
</div>

<p>
(It only includes the index key columns, not the included columns.)
</p>
</div>
</div>

<div id="outline-container-orgf9fccbc" class="outline-3">
<h3 id="orgf9fccbc">SQL Collation</h3>
<div class="outline-text-3" id="text-orgf9fccbc">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span>
    <span class="org-builtin">OBJECT_NAME</span>(<span class="org-builtin">object_id</span>)              <span class="org-keyword">AS</span> <span class="org-keyword">table</span>,
    col.<span class="org-keyword">name</span>,
    col.<span class="org-keyword">collation_name</span>
<span class="org-keyword">FROM</span> sys.columns                        col
<span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span>
    <span class="org-builtin">OBJECT_NAME</span>(<span class="org-builtin">object_id</span>),
    col.<span class="org-keyword">name</span>;
</pre>
</div>

<p>
<b>NOTE --</b> Liste des collations de SQL Server :
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span> *
<span class="org-keyword">FROM</span> ::fn_helpcollations();
</pre>
</div>
</div>
</div>

<div id="outline-container-org39b79d1" class="outline-3">
<h3 id="org39b79d1">Finding and Eliminating Duplicate or Overlapping Indexes</h3>
<div class="outline-text-3" id="text-org39b79d1">
<p>
Effective indexing is the key to keeping your queries running quickly while
consuming as few resources as possible in the process.  Each index that is added
to a table will increase the speed of reads that are now able to utilize that
index, but at the cost of speed whenever that index needs to be updated.  In
addition, your index maintenance processes (rebuilding/reorganizing) will now
have an additional index to operate on.
</p>

<p>
SQL Server has no safeguards against indexes that duplicate behavior, and
therefore a table could conceivably have any number of duplicate or overlapping
indexes on it without your ever knowing they were there!  This would constitute
an unnecessary drain on resources that could easily be avoided.  How do we
easily view our current indexes and determine if duplicates exist?  What about
indexes that contain overlapping column lists that could be combined?
</p>

<p>
<a href="http://www.sqlservercentral.com/articles/Indexing/110106/">http://www.sqlservercentral.com/articles/Indexing/110106/</a>
</p>

<p>
The best request out of it?
</p>

<div class="org-src-container">
<pre class="src src-sql">;<span class="org-keyword">WITH</span> CTE_INDEX_DATA <span class="org-keyword">AS</span> (
       <span class="org-keyword">SELECT</span>
              SCHEMA_DATA.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> <span class="org-keyword">schema_name</span>,
              TABLE_DATA.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> <span class="org-keyword">table_name</span>,
              INDEX_DATA.<span class="org-keyword">name</span> <span class="org-keyword">AS</span> index_name,
              <span class="org-builtin">STUFF</span>((<span class="org-keyword">SELECT</span>  <span class="org-string">', '</span> + COLUMN_DATA_KEY_COLS.<span class="org-keyword">name</span> + <span class="org-string">' '</span> + <span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> INDEX_COLUMN_DATA_KEY_COLS.is_descending_key = 1 <span class="org-keyword">THEN</span> <span class="org-string">'DESC'</span> <span class="org-keyword">ELSE</span> <span class="org-string">'ASC'</span> <span class="org-keyword">END</span> <span class="org-comment">-- Include column order (ASC / DESC).</span>

                                  <span class="org-keyword">FROM</span>    sys.tables <span class="org-keyword">AS</span> T
                                                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.indexes INDEX_DATA_KEY_COLS
                                                <span class="org-keyword">ON</span> T.<span class="org-builtin">object_id</span> = INDEX_DATA_KEY_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.index_columns INDEX_COLUMN_DATA_KEY_COLS
                                                <span class="org-keyword">ON</span> INDEX_DATA_KEY_COLS.<span class="org-builtin">object_id</span> = INDEX_COLUMN_DATA_KEY_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">AND</span> INDEX_DATA_KEY_COLS.index_id = INDEX_COLUMN_DATA_KEY_COLS.index_id
                                                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.columns COLUMN_DATA_KEY_COLS
                                                <span class="org-keyword">ON</span> T.<span class="org-builtin">object_id</span> = COLUMN_DATA_KEY_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">AND</span> INDEX_COLUMN_DATA_KEY_COLS.column_id = COLUMN_DATA_KEY_COLS.column_id
                                  <span class="org-keyword">WHERE</span>   INDEX_DATA.<span class="org-builtin">object_id</span> = INDEX_DATA_KEY_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">AND</span> INDEX_DATA.index_id = INDEX_DATA_KEY_COLS.index_id
                                                <span class="org-keyword">AND</span> INDEX_COLUMN_DATA_KEY_COLS.is_included_column = 0
                                  <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> INDEX_COLUMN_DATA_KEY_COLS.key_ordinal
                                  <span class="org-keyword">FOR</span> XML <span class="org-keyword">PATH</span>(<span class="org-string">''</span>)), 1, 2, <span class="org-string">''</span>) <span class="org-keyword">AS</span> key_column_list ,
          <span class="org-builtin">STUFF</span>(( <span class="org-keyword">SELECT</span>  <span class="org-string">', '</span> + COLUMN_DATA_INC_COLS.<span class="org-keyword">name</span>
                                  <span class="org-keyword">FROM</span>    sys.tables <span class="org-keyword">AS</span> T
                                                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.indexes INDEX_DATA_INC_COLS
                                                <span class="org-keyword">ON</span> T.<span class="org-builtin">object_id</span> = INDEX_DATA_INC_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.index_columns INDEX_COLUMN_DATA_INC_COLS
                                                <span class="org-keyword">ON</span> INDEX_DATA_INC_COLS.<span class="org-builtin">object_id</span> = INDEX_COLUMN_DATA_INC_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">AND</span> INDEX_DATA_INC_COLS.index_id = INDEX_COLUMN_DATA_INC_COLS.index_id
                                                <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.columns COLUMN_DATA_INC_COLS
                                                <span class="org-keyword">ON</span> T.<span class="org-builtin">object_id</span> = COLUMN_DATA_INC_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">AND</span> INDEX_COLUMN_DATA_INC_COLS.column_id = COLUMN_DATA_INC_COLS.column_id
                                  <span class="org-keyword">WHERE</span>   INDEX_DATA.<span class="org-builtin">object_id</span> = INDEX_DATA_INC_COLS.<span class="org-builtin">object_id</span>
                                                <span class="org-keyword">AND</span> INDEX_DATA.index_id = INDEX_DATA_INC_COLS.index_id
                                                <span class="org-keyword">AND</span> INDEX_COLUMN_DATA_INC_COLS.is_included_column = 1
                                  <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> INDEX_COLUMN_DATA_INC_COLS.key_ordinal
                                  <span class="org-keyword">FOR</span> XML <span class="org-keyword">PATH</span>(<span class="org-string">''</span>)), 1, 2, <span class="org-string">''</span>) <span class="org-keyword">AS</span> include_column_list,
       INDEX_DATA.is_disabled <span class="org-comment">-- Check if index is disabled before determining which dupe to drop (if applicable).</span>
       <span class="org-keyword">FROM</span> sys.indexes INDEX_DATA
       <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.tables TABLE_DATA
       <span class="org-keyword">ON</span> TABLE_DATA.<span class="org-builtin">object_id</span> = INDEX_DATA.<span class="org-builtin">object_id</span>
       <span class="org-keyword">INNER</span> <span class="org-keyword">JOIN</span> sys.schemas SCHEMA_DATA
       <span class="org-keyword">ON</span> SCHEMA_DATA.schema_id = TABLE_DATA.schema_id
       <span class="org-keyword">WHERE</span> TABLE_DATA.is_ms_shipped = 0
       <span class="org-keyword">AND</span> INDEX_DATA.type_desc <span class="org-keyword">IN</span> (<span class="org-string">'NONCLUSTERED'</span>, <span class="org-string">'CLUSTERED'</span>)
)
<span class="org-keyword">SELECT</span>
       *
<span class="org-keyword">FROM</span> CTE_INDEX_DATA DUPE1
<span class="org-keyword">WHERE</span> <span class="org-keyword">EXISTS</span>
(<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> CTE_INDEX_DATA DUPE2
 <span class="org-keyword">WHERE</span> DUPE1.<span class="org-keyword">schema_name</span> = DUPE2.<span class="org-keyword">schema_name</span>
 <span class="org-keyword">AND</span> DUPE1.<span class="org-keyword">table_name</span> = DUPE2.<span class="org-keyword">table_name</span>
 <span class="org-keyword">AND</span> (DUPE1.key_column_list <span class="org-keyword">LIKE</span> <span class="org-keyword">LEFT</span>(DUPE2.key_column_list, <span class="org-builtin">LEN</span>(DUPE1.key_column_list)) <span class="org-keyword">OR</span> DUPE2.key_column_list <span class="org-keyword">LIKE</span> <span class="org-keyword">LEFT</span>(DUPE1.key_column_list, <span class="org-builtin">LEN</span>(DUPE2.key_column_list)))
 <span class="org-keyword">AND</span> DUPE1.index_name &lt;&gt; DUPE2.index_name)
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Fabrice Niessen</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
